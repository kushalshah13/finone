<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinOne - AI Financial Planner</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DCF58S10GZ"></script>
    <script>

        // ============ V2.0 FUNCTIONS ============
        
        let salaryType = 'gross';
        
        // Indian tax calculation (New Tax Regime FY 2025-26)
        function calculateIncomeTax(grossSalary) {
            let taxableIncome = grossSalary - 75000;
            let tax = 0;
            
            if (taxableIncome <= 300000) {
                tax = 0;
            } else if (taxableIncome <= 700000) {
                tax = (taxableIncome - 300000) * 0.05;
            } else if (taxableIncome <= 1000000) {
                tax = 20000 + (taxableIncome - 700000) * 0.10;
            } else if (taxableIncome <= 1200000) {
                tax = 50000 + (taxableIncome - 1000000) * 0.15;
            } else if (taxableIncome <= 1500000) {
                tax = 80000 + (taxableIncome - 1200000) * 0.20;
            } else {
                tax = 140000 + (taxableIncome - 1500000) * 0.30;
            }
            
            tax = tax * 1.04;
            if (taxableIncome <= 700000) tax = Math.max(0, tax - 25000);
            return Math.round(tax);
        }
        
        function updateTaxInfo() {
            const salaryInput = document.getElementById('annualSalary');
            const taxInfoDiv = document.getElementById('taxInfo');
            const salary = parseFloat(salaryInput.value) || 0;
            
            if (salary > 0 && salaryType === 'gross') {
                const tax = calculateIncomeTax(salary);
                const netSalary = salary - tax;
                taxInfoDiv.style.display = 'block';
                taxInfoDiv.innerHTML = `üìä Approx Tax: ‚Çπ${tax.toLocaleString('en-IN')} | Net: ‚Çπ${netSalary.toLocaleString('en-IN')}<br><small style="opacity:0.7;">*New Tax Regime (FY 2025-26)</small>`;
            } else {
                taxInfoDiv.style.display = 'none';
            }
        }
        
        function toggleSalaryType(type) {
            salaryType = type;
            const grossToggle = document.getElementById('grossToggle');
            const netToggle = document.getElementById('netToggle');
            const salaryLabel = document.getElementById('salaryLabel');
            const salaryTooltip = document.getElementById('salaryTooltip');
            
            if (type === 'gross') {
                grossToggle.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                grossToggle.style.color = 'white';
                grossToggle.style.border = 'none';
                netToggle.style.background = 'white';
                netToggle.style.color = '#667eea';
                netToggle.style.border = '2px solid #667eea';
                salaryLabel.textContent = 'Annual Gross Salary (‚Çπ)';
                salaryTooltip.textContent = 'Your total CTC. Tax calculated using Indian slabs (approximate).';
            } else {
                netToggle.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                netToggle.style.color = 'white';
                netToggle.style.border = 'none';
                grossToggle.style.background = 'white';
                grossToggle.style.color = '#667eea';
                grossToggle.style.border = '2px solid #667eea';
                salaryLabel.textContent = 'Annual Net Take-Home (‚Çπ)';
                salaryTooltip.textContent = 'Your actual take-home after deductions.';
            }
            updateTaxInfo();
        }
        
        // Load realistic demo data (PDF Page 10)
        function loadDemoData() {
            // Basic info
            document.getElementById('age').value = 34;
            document.getElementById('retirementAge').value = 60;
            
            // Income
            document.getElementById('annualSalary').value = 4500000;
            
            // Investments
            document.getElementById('monthlySIP').value = 50000;
            document.getElementById('sipStepup').value = 10;
            document.getElementById('sipPortfolio').value = 1500000;
            document.getElementById('directEquity').value = 1250000;
            
            // Assets
            document.getElementById('goldHoldings').value = 200000;
            document.getElementById('realEstate').value = 0;
            document.getElementById('otherAssets').value = 100000;
            document.getElementById('bankBalance').value = 300000;
            document.getElementById('propertyValue').value = 12000000;
            
            // Expenses
            document.getElementById('monthlyExpenses').value = 80000;
            if (document.getElementById('holidayBudget')) {
                document.getElementById('holidayBudget').value = 300000;
            }
            
            // Liabilities
            document.getElementById('homeLoan').value = 8000000;
            document.getElementById('loanRate').value = 8.5;
            if (document.getElementById('homeLoanPrepay')) {
                document.getElementById('homeLoanPrepay').value = 0;
            }
            
            // Insurance
            document.getElementById('lifeInsurance').value = 5000000;
            document.getElementById('insurancePremium').value = 35000;
            
            // Children
            document.getElementById('childrenAges').value = '4,7';
            document.getElementById('educationCosts').value = '200000,150000';
            
            // Update tax info display
            updateTaxInfo();
            
            alert('‚úÖ Realistic demo data loaded!\n\nAge: 34 ‚Üí Retirement: 60\nGross Salary: ‚Çπ45L\nExpected corpus: ~‚Çπ18-25 Cr\n\nClick "Generate Financial Plan"');
        }
        
        // HARDCODED API KEY - Replace 'YOUR_KEY_HERE' with your actual Anthropic API key
        // Get your key from: https://console.anthropic.com
        // Set usage limits on the console to control costs
        const ANTHROPIC_API_KEY = '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';

      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      
      gtag('config', 'G-DCF58S10GZ');
    </script>
    
    <!-- Libraries for Excel and PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
        }
        
        .header {
            background: linear-gradient(135deg, #0f4c75 0%, #1b6ca8 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 15s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 0;
            min-height: 750px;
        }
        
        .input-panel {
            background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
            border-right: 3px solid #dee2e6;
            padding: 30px;
            overflow-y: auto;
            max-height: 85vh;
        }
        
        .output-panel {
            padding: 30px;
            overflow-y: auto;
            max-height: 85vh;
            background: #ffffff;
        }
        
        /* Document Upload Section */
        .upload-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .upload-section h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .upload-section p {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 12px;
        }
        
        .upload-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .upload-btn:hover {
            background: #f0f0f0;
        }
        
        .api-info {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        .api-info a {
            color: white;
            text-decoration: underline;
        }
        
        /* Input Sections */
        .input-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }
        
        .input-section h3 {
            color: #0f4c75;
            margin-bottom: 16px;
            font-size: 1.05rem;
            border-bottom: 2px solid #0f4c75;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-icon {
            font-size: 1.2rem;
        }
        
        .input-group {
            margin-bottom: 16px;
            position: relative;
        }
        
        .input-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .info-icon {
            cursor: help;
            color: #667eea;
            font-size: 0.85rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #667eea;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .info-icon:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }
        
        .tooltip {
            position: absolute;
            background: #2c3e50;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            line-height: 1.4;
            z-index: 1000;
            width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            left: 50%;
            transform: translateX(-50%);
            top: -10px;
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #2c3e50;
        }
        
        .info-icon:hover + .tooltip,
        .tooltip:hover {
            display: block;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input-group.derived input {
            background: #e7f3ff;
            border-color: #0f4c75;
            font-weight: 600;
        }
        
        .derived-badge {
            display: inline-block;
            background: #0f4c75;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 6px;
            font-weight: 600;
        }
        
        .suggested-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 6px;
            font-weight: 600;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }
        
        .calculate-btn:active {
            transform: translateY(-1px);
        }
        
        /* Health Score Card */
        .metric-card {
            background: linear-gradient(135deg, #0f4c75 0%, #1b6ca8 100%);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(15, 76, 117, 0.3);
        }
        
        .metric-card h2 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            opacity: 0.95;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .metric-card .value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .metric-card .subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .explain-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .explain-btn:hover {
            background: white;
            color: #0f4c75;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        
        .tab {
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            color: #6c757d;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* Results Grid */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 25px;
        }
        
        .result-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            transition: all 0.2s;
        }
        
        .result-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            border-color: #667eea;
        }
        
        .result-card h4 {
            color: #0f4c75;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        
        .result-card .amount {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 6px;
        }
        
        .result-card .description {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        /* Alerts */
        .alert {
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 18px;
            border-left: 5px solid;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .alert strong {
            display: block;
            margin-bottom: 8px;
            font-size: 1.05rem;
        }
        
        .alert p {
            margin: 6px 0;
            font-size: 0.9rem;
        }
        
        /* Progress Bar */
        .progress-bar {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            height: 24px;
            margin-top: 12px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            transition: width 1s ease;
        }
        
        /* Action List */
        .action-list {
            margin-top: 20px;
        }
        
        .action-list h3 {
            margin-bottom: 16px;
            font-size: 1.15rem;
        }
        
        .action-item {
            background: white;
            border-left: 5px solid;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .action-item.urgent {
            border-color: #dc3545;
            background: #fff5f5;
        }
        
        .action-item.high {
            border-color: #ffc107;
            background: #fffef5;
        }
        
        .action-item strong {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 1rem;
        }
        
        .action-item p {
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .section-title {
            color: #0f4c75;
            font-size: 1.5rem;
            margin-bottom: 20px;
            border-bottom: 3px solid #0f4c75;
            padding-bottom: 10px;
        }
        
        /* Scenario Variables Panel */
        .variables-panel {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
        }
        
        .variables-panel h3 {
            color: #0f4c75;
            margin-bottom: 16px;
            font-size: 1.1rem;
        }
        
        .variable-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .variable-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .variable-item label {
            display: block;
            font-weight: 600;
            font-size: 0.85rem;
            color: #495057;
            margin-bottom: 6px;
        }
        
        .variable-item input {
            width: 100%;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 12px;
        }
        
        .modal-header h2 {
            color: #0f4c75;
            font-size: 1.5rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: #f8f9fa;
            color: #dc3545;
        }
        
        .score-breakdown {
            margin-top: 16px;
        }
        
        .score-item {
            background: #f8f9fa;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }
        
        .score-item h4 {
            color: #0f4c75;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }
        
        .score-item p {
            color: #495057;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .score-value {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .input-panel {
                border-right: none;
                border-bottom: 3px solid #dee2e6;
                max-height: none;
            }
            
            .output-panel {
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ FinOne AI Financial Planner</h1>
            <p>Smart Financial Planning Powered by AI | Upload Documents or Enter Details</p>
        </div>
        
                <!-- DISCLAIMER -->
        <div style="background: #FFF3CD; border-left: 5px solid #FFC107; padding: 18px 30px; margin: 20px 40px 30px 40px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="font-weight: 700; color: #856404; font-size: 1.05rem; margin-bottom: 8px;">
                ‚ö†Ô∏è Important Disclaimer
            </div>
            <div style="color: #856404; font-size: 0.88rem; line-height: 1.6;">
                This tool is for <strong>experimentation and demo purposes only</strong>. It is NOT actual financial advice. Tax calculations are approximate estimates. Consult a certified financial advisor before making any investment decisions.
            </div>
        </div>

<div class="main-content">
            <div class="input-panel">

                <!-- Basic Information -->
                <div class="input-section">
                    <h3><span class="section-icon">üë§</span> Basic Information</h3>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Current Age</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Your current age in years. This determines your investment horizon and retirement timeline.</div>
                        </div>
                        <input type="number" id="age" placeholder="e.g., 34" min="18" max="100" required>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Target Retirement Age</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">The age at which you plan to retire. Typically 60-65 years. Earlier retirement requires more aggressive saving.</div>
                        </div>
                        <input type="number" id="retirementAge" placeholder="e.g., 60" min="40" max="80" required>
                    </div>
                </div>
                
                <!-- Income & Savings -->
                <div class="input-section">
                    <h3><span class="section-icon">üíµ</span> Income & Savings</h3>

                    <!-- TAX TOGGLE -->
                    <div class="input-group">
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button type="button" id="grossToggle" onclick="toggleSalaryType('gross')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                                Annual Gross Salary
                            </button>
                            <button type="button" id="netToggle" onclick="toggleSalaryType('net')" style="flex: 1; padding: 12px; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                                Annual Net Take-Home
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span id="salaryLabel">Annual Gross Salary (‚Çπ)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip" id="salaryTooltip">Your total CTC. Tax calculated using Indian slabs (approximate).</div>
                        </div>
                        <input type="number" id="annualSalary" placeholder="e.g., 4500000" step="100000" required oninput="updateTaxInfo()">
                        <div id="taxInfo" style="margin-top: 10px; padding: 10px; background: #f0f4ff; border-radius: 6px; font-size: 0.85rem; color: #495057; display: none;"></div>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Current MF SIP Investment (‚Çπ/month)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Regular monthly investment in mutual funds/SIPs. Recommended: 20-30% of monthly income for long-term wealth building.</div>
                        </div>
                        <input type="number" id="monthlySIP" placeholder="e.g., 100000" step="5000" required>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Annual SIP Step-up (%)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Yearly increase in SIP amount. Recommended: 10-15% to match salary increments and beat inflation.</div>
                        </div>
                        <input type="number" id="sipStepup" placeholder="e.g., 10" step="1" min="0" max="30" required>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Current SIP Portfolio (‚Çπ)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Total current value of your mutual fund/SIP investments. Check your portfolio statement or app.</div>
                        </div>
                        <input type="number" id="sipPortfolio" placeholder="e.g., 3500000" step="100000" required>
                    </div>
                </div>
                
                <!-- Expenses & Liabilities -->
                <div class="input-section">
                    <h3><span class="section-icon">üè†</span> Expenses & Liabilities</h3>

                    <div class="input-group">
                        <div class="input-label">
                            <span>Monthly Living Expenses (‚Çπ)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Essential monthly expenses: rent, utilities, groceries, transport, etc. Exclude EMIs, investments, and discretionary spending. Ideally upload bank statements for accurate calculation.</div>
                        </div>
                        <input type="number" id="monthlyExpenses" placeholder="e.g., 80000" step="5000" required>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Home Loan Outstanding (‚Çπ)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Remaining home loan principal. Check your latest loan statement. This affects your insurance needs and prepayment strategy. Enter 0 if no loan.</div>
                        </div>
                        <input type="number" id="homeLoan" placeholder="e.g., 10000000 or 0" step="100000">
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Home Loan Interest Rate (%)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Annual interest rate on your home loan. Check your loan agreement. Typical range: 8-9% for home loans in India. Leave at 8.5 if no loan.</div>
                        </div>
                        <input type="number" id="loanRate" placeholder="e.g., 8.5" step="0.1" min="0" max="20">
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Property Value (where loan is running) (‚Çπ)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Current market value of property with home loan. For net worth calculation.</div>
                        </div>
                        <input type="number" id="propertyValue" placeholder="e.g., 12000000" step="100000">
                    </div>
                    
                    <div class="input-group" style="display: none;">
                        <div class="input-label">
                            <span>Annual Loan Prepayment (‚Çπ)</span>
                            <span class="suggested-badge">SUGGESTED</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Extra amount paid annually to reduce loan principal. Suggested: 3x your monthly EMI (‚Çπ2.4L based on typical ‚Çπ80K EMI). Saves massive interest and achieves debt freedom faster. Enter 0 if not planning to prepay.</div>
                        </div>
                        <input type="number" id="homeLoanPrepay" placeholder="e.g., 240000 or 0" step="10000">
                    </div>
                </div>
                
                <!-- Assets & Emergency -->
                <div class="input-section">
                    <h3><span class="section-icon">üè¶</span> Assets & Emergency Fund</h3>

                    <div class="input-group">
                        <div class="input-label">
                            <span>Bank Balance + Liquid Funds (‚Çπ)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Cash in savings accounts and liquid mutual funds. These are your immediately accessible funds for emergencies.</div>
                        </div>
                        <input type="number" id="bankBalance" placeholder="e.g., 500000" step="50000" required>
                    </div>
                    
                    <div class="input-group derived">
                        <div class="input-label">
                            <span>Emergency Fund Target (‚Çπ)</span>
                            <span class="derived-badge">AUTO-CALCULATED</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Recommended: 6 months of expenses + 1 year of EMIs. This is NOT just cash in bank - it's a strategic allocation across: (1) 40% in savings bank account for instant access, (2) 40% in liquid mutual funds (1-day withdrawal), (3) 20% in ultra-short debt funds (3-5 day withdrawal). This covers job loss, medical emergencies without disrupting long-term investments. Auto-calculated based on your inputs.</div>
                        </div>
                        <input type="number" id="emergencyTarget" placeholder="Auto-calculated" readonly>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Direct Equity Holdings (‚Çπ)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Stocks you own directly (not through mutual funds). Check your demat account. Higher risk, higher potential returns. Enter 0 if none.</div>
                        </div>
                        <input type="number" id="directEquity" placeholder="e.g., 1000000 or 0" step="50000">
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Gold Holdings (‚Çπ)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Physical gold, gold ETFs, sovereign gold bonds, digital gold. Current market value.</div>
                        </div>
                        <input type="number" id="goldHoldings" placeholder="e.g., 200000" step="50000">
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Real Estate - Loan-Free (‚Çπ)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Properties you own WITHOUT running loans. Do NOT include property with home loan. Enter 0 if none.</div>
                        </div>
                        <input type="number" id="realEstate" placeholder="e.g., 5000000 or 0" step="100000">
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Other Assets (‚Çπ)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Bonds, cryptocurrency, commodities, art, collectibles. Total current value.</div>
                        </div>
                        <input type="number" id="otherAssets" placeholder="e.g., 100000" step="50000">
                    </div>
                </div>
                
                <!-- Insurance -->
                <div class="input-section">
                    <h3><span class="section-icon">üõ°Ô∏è</span> Insurance</h3>

                    <div class="input-group">
                        <div class="input-label">
                            <span>Current Life Insurance Cover (‚Çπ)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Total death benefit from all term insurance policies. Check policy documents. Does NOT include ULIP or endowment maturity value. Enter 0 if none.</div>
                        </div>
                        <input type="number" id="lifeInsurance" placeholder="e.g., 10000000 or 0" step="500000">
                    </div>
                    
                    <div class="input-group derived">
                        <div class="input-label">
                            <span>Recommended Life Cover (‚Çπ)</span>
                            <span class="derived-badge">AUTO-CALCULATED</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Suggested coverage: 10x annual salary + outstanding loans. At 10% interest, this generates annual income to replace your salary + covers debts. Auto-calculated.</div>
                        </div>
                        <input type="number" id="insuranceNeeded" placeholder="Auto-calculated" readonly>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Annual Insurance Premium (‚Çπ)</span>
                            <span class="suggested-badge">YEARLY</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Total yearly premium for all term insurance policies. For ‚Çπ4.5Cr cover at age 34, expect ‚Çπ30-40K/year. Check with insurers for exact quotes. Enter 0 if no insurance.</div>
                        </div>
                        <input type="number" id="insurancePremium" placeholder="e.g., 35000 or 0" step="1000">
                    </div>
                </div>
                
                <!-- Goals -->
                <div class="input-section">
                    <h3><span class="section-icon">üéØ</span> Life Goals</h3>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Children's Ages (comma-separated)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Enter ages separated by commas. Example: "4,7" for two children. Leave blank if none.</div>
                        </div>
                        <input type="text" id="childrenAges" placeholder="e.g., 4,7 or blank">
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Current Annual Education Costs (‚Çπ, comma-separated)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Yearly expenses per child. Example: "200000,150000". Inflates 8%/year, spikes 4x for ages 18-22.</div>
                        </div>
                        <input type="text" id="educationCosts" placeholder="e.g., 200000,150000">
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Annual Holiday Budget (‚Çπ)</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Your yearly vacation spending. We'll increase this faster than regular inflation (12% vs 6%) because lifestyle aspirations grow with wealth. Enter 0 if not planning vacations.</div>
                        </div>
                        <input type="number" id="holidayBudget" placeholder="e.g., 300000 or 0" step="50000">
                    </div>
                </div>
                
                <!-- Investment Assumptions -->
                
                <!-- Retirement Planning -->
                <div class="input-section">
                    <h3><span class="section-icon">üèñÔ∏è</span> Retirement Planning</h3>
                    
                    <div class="input-group derived">
                        <div class="input-label">
                            <span>Retirement Corpus Needed (‚Çπ)</span>
                            <span class="derived-badge">AUTO-CALCULATED</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Amount needed at retirement to sustain your lifestyle for 25 years. Based on projected expenses at age 60, accounting for inflation. Auto-calculated using 4% withdrawal rule.</div>
                        </div>
                        <input type="number" id="retirementCorpus" placeholder="Auto-calculated" readonly>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Post-Retirement Return (%)</span>
                            <span class="suggested-badge">SUGGESTED: 8%</span>
                            <span class="info-icon">i</span>
                            <div class="tooltip">Conservative returns after retirement. Mix of debt (60%) and equity (40%). Typical: 8%. Need regular income with lower risk.</div>
                        </div>
                        <input type="number" id="postRetirementReturn" placeholder="e.g., 8" step="0.5" min="0" max="15" required>
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculatePlan()">üöÄ Generate Financial Plan</button>
                
                <button class="calculate-btn" onclick="loadDemoData()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-top: 10px; font-size: 0.9rem; padding: 10px;">
                    üéØ Load Demo Data (For Testing)
                </button>
            </div>
            
            <div class="output-panel" id="outputPanel">
                <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <h2 style="font-size: 2rem; margin-bottom: 16px;">üëã Welcome to FinOne AI!</h2>
                    <p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 24px;">
                        <strong>Two ways to start:</strong><br>
                        <span style="font-size: 1rem;">1. ü§ñ Upload documents + API key for AI auto-fill<br>
                        2. ‚úçÔ∏è Fill the form manually</span>
                    </p>
                    
                    <div style="background: #f0f4ff; border-radius: 12px; padding: 20px; margin: 24px auto; max-width: 500px; text-align: left;">
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 12px; font-size: 1.05rem;">üöÄ AI-Powered Features:</div>
                        <ul style="margin-left: 20px; line-height: 1.8; font-size: 0.95rem; color: #495057;">
                            <li>üìÑ Document upload & auto-extraction</li>
                            <li>üéØ Personalized allocation advice</li>
                            <li>üí¨ AI financial advisor chat</li>
                            <li>üìä Detailed health score analysis</li>
                            <li>üîÑ Smart scenario planning</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 30px; font-size: 3rem; opacity: 0.3;">üìäüí∞üéØ</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Health Score Explanation Modal -->
    <div class="modal" id="scoreModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Understanding Your Financial Health Score</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            
            <div class="score-breakdown">
                <div class="score-item">
                    <h4>üéØ Score Range: 0-100</h4>
                    <p><span class="score-value">90-100:</span> Excellent - You're on track for early retirement with surplus wealth</p>
                    <p><span class="score-value">75-89:</span> Good - Retirement secured, minor optimizations possible</p>
                    <p><span class="score-value">60-74:</span> Fair - On track but needs attention to gaps</p>
                    <p><span class="score-value">Below 60:</span> Needs Work - Significant gaps need immediate action</p>
                </div>
                
                <div class="score-item">
                    <h4>üíº What Impacts Your Score</h4>
                    <p><strong>Portfolio Performance (40%):</strong> Are you meeting or exceeding retirement corpus needs?</p>
                    <p><strong>Emergency Preparedness (20%):</strong> Do you have 6+ months expenses in liquid funds?</p>
                    <p><strong>Insurance Adequacy (20%):</strong> Is your family protected with sufficient life cover?</p>
                    <p><strong>Debt Management (20%):</strong> Are you actively prepaying loans and reducing liabilities?</p>
                </div>
                
                <div class="score-item">
                    <h4>üìà How to Improve Your Score</h4>
                    <p>1. Increase SIP investments and step-ups</p>
                    <p>2. Build emergency fund to 6+ months of expenses</p>
                    <p>3. Get adequate life insurance (10x salary + loans)</p>
                    <p>4. Prepay loans aggressively to reduce interest burden</p>
                    <p>5. Diversify into direct equity and real estate over time</p>
                </div>
                
                <button class="calculate-btn" onclick="getAIHealthInsights()" style="margin-top: 20px;">
                    ü§ñ Get AI-Powered Detailed Health Analysis
                </button>
                <div id="aiHealthInsights" style="margin-top: 16px;"></div>
            </div>
        </div>
    </div>
    
    <script>
        let currentResults = null;
        
        let uploadedDocuments = [];
        let extractedData = {};
        
        
        
        function downloadExcelReport() {
            if (!currentResults) {
                alert('Please generate your financial plan first!');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const results = currentResults;
            const inputs = results.inputs;
            
            // Summary Sheet
            const summaryData = [
                ['COMPREHENSIVE FINANCIAL PLAN'],
                ['Generated on: ' + new Date().toLocaleDateString()],
                [],
                ['EXECUTIVE SUMMARY'],
                ['Current Age', inputs.age],
                ['Retirement Age', inputs.retirementAge],
                ['Years to Retirement', inputs.retirementAge - inputs.age],
                ['Financial Health Score', results.healthScore + '/100'],
                [],
                ['CURRENT POSITION'],
                ['Total Assets', results.inputs.sipPortfolio + results.inputs.directEquity + results.inputs.realEstate + results.inputs.bankBalance],
                ['Total Liabilities', results.inputs.homeLoan],
                ['Net Worth', (results.inputs.sipPortfolio + results.inputs.directEquity + results.inputs.realEstate + results.inputs.bankBalance) - results.inputs.homeLoan],
                [],
                ['RETIREMENT PROJECTION'],
                ['Portfolio at Retirement', results.finalPortfolio],
                ['Corpus Required', results.corpusNeeded],
                ['Surplus/Gap', results.gap],
                ['Status', results.gap >= 0 ? 'ON TRACK' : 'NEEDS ADJUSTMENT'],
                [],
                ['CRITICAL GAPS'],
                ['Emergency Fund Gap', results.emergencyGap],
                ['Insurance Gap', results.insuranceGap]
            ];
            const ws_summary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws_summary, 'Summary');
            
            // Year by Year Projection
            const projectionHeaders = [['Year', 'Age', 'SIP Portfolio', 'Direct Equity', 'Real Estate', 'Liquid/Debt', 'Home Loan', 'Annual Expenses', 'Total Portfolio']];
            const projectionData = results.projection.map(p => [
                p.year,
                p.age,
                p.sipPortfolio,
                p.directEquity,
                p.realEstate,
                p.liquid,
                p.homeLoan,
                p.expenses,
                p.sipPortfolio + p.directEquity + p.realEstate + p.liquid
            ]);
            const ws_projection = XLSX.utils.aoa_to_sheet([...projectionHeaders, ...projectionData]);
            XLSX.utils.book_append_sheet(wb, ws_projection, 'Year-by-Year');
            
            // Asset Breakdown Sheet
            const finalYear = results.projection[results.projection.length - 1];
            const assetData = [
                ['PORTFOLIO BREAKDOWN AT RETIREMENT'],
                [],
                ['Asset Class', 'Value', 'Percentage'],
                ['SIP/Mutual Funds', finalYear.sipPortfolio, ((finalYear.sipPortfolio / results.finalPortfolio) * 100).toFixed(1) + '%'],
                ['Direct Equity', finalYear.directEquity, ((finalYear.directEquity / results.finalPortfolio) * 100).toFixed(1) + '%'],
                ['Real Estate', finalYear.realEstate, ((finalYear.realEstate / results.finalPortfolio) * 100).toFixed(1) + '%'],
                ['Liquid/Debt', finalYear.liquid, ((finalYear.liquid / results.finalPortfolio) * 100).toFixed(1) + '%'],
                [],
                ['Total', results.finalPortfolio, '100%']
            ];
            const ws_assets = XLSX.utils.aoa_to_sheet(assetData);
            XLSX.utils.book_append_sheet(wb, ws_assets, 'Asset Breakdown');
            
            // Recommendations Sheet
            const recoData = [
                ['ACTION PLAN'],
                [],
                ['IMMEDIATE ACTIONS (Next 30 Days)'],
                ['1. Emergency Fund', 'Build ' + formatCurrency(results.emergencyGap) + ' emergency fund'],
                ['2. Life Insurance', 'Get quotes for ' + formatCurrency(results.insuranceGap) + ' additional coverage'],
                ['3. Loan Prepayment', 'Set up ' + formatCurrency(inputs.homeLoanPrepay) + ' annual prepayment'],
                [],
                ['ONGOING DISCIPLINE'],
                ['SIP Increase', 'Increase by ' + (inputs.sipStepup * 100).toFixed(0) + '% annually'],
                ['Portfolio Review', 'Rebalance every 6 months'],
                ['Tax Optimization', 'Maximize 80C, 80D, 80CCD(1B)']
            ];
            const ws_reco = XLSX.utils.aoa_to_sheet(recoData);
            XLSX.utils.book_append_sheet(wb, ws_reco, 'Recommendations');
            
            // Download
            XLSX.writeFile(wb, 'Financial_Health_Report_' + new Date().toISOString().split('T')[0] + '.xlsx');
        }
        
        function downloadPDFReport() {
            if (!currentResults) {
                alert('Please generate your financial plan first!');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const results = currentResults;
            const inputs = results.inputs;
            
            let yPos = 20;
            
            // Title
            doc.setFontSize(20);
            doc.setTextColor(15, 76, 117);
            doc.text('COMPREHENSIVE FINANCIAL PLAN', 105, yPos, { align: 'center' });
            
            yPos += 10;
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text('Financial Health Analysis & Retirement Planning', 105, yPos, { align: 'center' });
            
            yPos += 8;
            doc.setFontSize(10);
            doc.text('Generated: ' + new Date().toLocaleDateString(), 105, yPos, { align: 'center' });
            
            // Executive Summary
            yPos += 15;
            doc.setFontSize(14);
            doc.setTextColor(0);
            doc.text('EXECUTIVE SUMMARY', 20, yPos);
            
            yPos += 10;
            doc.setFontSize(10);
            doc.setTextColor(60);
            
            const totalAssets = inputs.sipPortfolio + inputs.directEquity + inputs.realEstate + inputs.bankBalance;
            const netWorth = totalAssets - inputs.homeLoan;
            
            doc.text(`Current Net Worth: ${formatCurrency(netWorth)}`, 20, yPos);
            yPos += 6;
            doc.text(`Total Assets: ${formatCurrency(totalAssets)}`, 20, yPos);
            yPos += 6;
            doc.text(`Projected at Age ${inputs.retirementAge}: ${formatCurrency(results.finalPortfolio)}`, 20, yPos);
            yPos += 6;
            doc.text(`Status: ${results.gap >= 0 ? 'ON TRACK for retirement' : 'NEEDS ADJUSTMENT'}`, 20, yPos);
            yPos += 6;
            doc.text(`Financial Health Score: ${results.healthScore}/100`, 20, yPos);
            
            // Current Financial Position
            yPos += 15;
            doc.setFontSize(14);
            doc.setTextColor(0);
            doc.text('CURRENT FINANCIAL POSITION', 20, yPos);
            
            yPos += 10;
            doc.autoTable({
                startY: yPos,
                head: [['Category', 'Amount', 'Percentage']],
                body: [
                    ['SIP/Mutual Funds', formatCurrency(inputs.sipPortfolio), ((inputs.sipPortfolio / totalAssets) * 100).toFixed(1) + '%'],
                    ['Direct Equity', formatCurrency(inputs.directEquity), ((inputs.directEquity / totalAssets) * 100).toFixed(1) + '%'],
                    ['Real Estate', formatCurrency(inputs.realEstate), ((inputs.realEstate / totalAssets) * 100).toFixed(1) + '%'],
                    ['Cash & Liquid', formatCurrency(inputs.bankBalance), ((inputs.bankBalance / totalAssets) * 100).toFixed(1) + '%'],
                    ['TOTAL ASSETS', formatCurrency(totalAssets), '100%'],
                    ['', '', ''],
                    ['Home Loan', formatCurrency(inputs.homeLoan), '-'],
                    ['NET WORTH', formatCurrency(netWorth), '-']
                ],
                theme: 'grid',
                headStyles: { fillColor: [15, 76, 117] },
                margin: { left: 20, right: 20 }
            });
            
            yPos = doc.lastAutoTable.finalY + 15;
            
            // Retirement Projection
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(14);
            doc.setTextColor(0);
            doc.text('RETIREMENT PROJECTION', 20, yPos);
            
            yPos += 10;
            doc.autoTable({
                startY: yPos,
                head: [['Metric', 'Value']],
                body: [
                    ['Years to Retirement', (inputs.retirementAge - inputs.age).toString()],
                    ['Monthly Expenses at ' + inputs.retirementAge, formatCurrency(results.monthlyExpensesAt60)],
                    ['Annual Expenses at ' + inputs.retirementAge, formatCurrency(results.annualExpensesAt60)],
                    ['Corpus Required (25 years)', formatCurrency(results.corpusNeeded)],
                    ['Projected Portfolio', formatCurrency(results.finalPortfolio)],
                    ['Surplus/Gap', formatCurrency(Math.abs(results.gap))],
                    ['Status', results.gap >= 0 ? `‚úì Surplus ${results.gapPercent.toFixed(1)}%` : `‚ö† Shortfall ${Math.abs(results.gapPercent).toFixed(1)}%`]
                ],
                theme: 'grid',
                headStyles: { fillColor: [15, 76, 117] },
                margin: { left: 20, right: 20 }
            });
            
            yPos = doc.lastAutoTable.finalY + 15;
            
            // Critical Gaps
            if (yPos > 220) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(14);
            doc.setTextColor(220, 53, 69);
            doc.text('CRITICAL GAPS & RISKS', 20, yPos);
            
            yPos += 10;
            const gapsData = [];
            
            if (results.emergencyGap > 0) {
                gapsData.push(['Emergency Fund Gap', formatCurrency(results.emergencyGap), 'URGENT']);
                gapsData.push(['Current', formatCurrency(inputs.bankBalance), '']);
                gapsData.push(['Required', formatCurrency(inputs.emergencyTarget), '']);
                gapsData.push(['', '', '']);
            }
            
            if (results.insuranceGap > 0) {
                gapsData.push(['Life Insurance Gap', formatCurrency(results.insuranceGap), 'URGENT']);
                gapsData.push(['Current Coverage', formatCurrency(inputs.lifeInsurance), '']);
                gapsData.push(['Recommended', formatCurrency(inputs.insuranceNeeded), '']);
            }
            
            if (gapsData.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    head: [['Gap Type', 'Amount', 'Priority']],
                    body: gapsData,
                    theme: 'grid',
                    headStyles: { fillColor: [220, 53, 69] },
                    margin: { left: 20, right: 20 }
                });
            } else {
                doc.setFontSize(10);
                doc.setTextColor(40, 167, 69);
                doc.text('‚úì No critical gaps identified. Excellent financial position!', 20, yPos);
            }
            
            // Download
            doc.save('Financial_Plan_Report_' + new Date().toISOString().split('T')[0] + '.pdf');
        }
        
        async function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const apiKey = ANTHROPIC_API_KEY.trim();
            if (!apiKey) {
                alert('‚ö†Ô∏è Please enter your Claude API key first!\n\nGet it from: console.anthropic.com\n\nFree tier includes $5 credit.');
                return;
            }
            
            // Store API key in session
            // API key is hardcoded
            
            // Show upload status
            const statusDiv = document.getElementById('analysisStatus');
            const filesDiv = document.getElementById('uploadedFiles');
            
            filesDiv.innerHTML = `<div style="color: white;">üìÅ ${files.length} file(s) selected</div>`;
            statusDiv.innerHTML = `<div style="color: white;">‚è≥ Analyzing documents with AI...</div>`;
            
            try {
                // Convert files to base64
                const documentsData = await Promise.all(
                    Array.from(files).map(file => fileToBase64(file))
                );
                
                uploadedDocuments = documentsData;
                
                // Analyze with Claude
                await analyzeDocumentsWithAI(documentsData);
                
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = `<div style="color: #ffcccc;">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve({
                        name: file.name,
                        type: file.type,
                        data: base64
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        async function analyzeDocumentsWithAI(documents) {
            const apiKey = ANTHROPIC_API_KEY;
            const statusDiv = document.getElementById('analysisStatus');
            
            // Prepare content for Claude
            const content = [
                {
                    type: "text",
                    text: `You are a financial planning assistant. Analyze these documents and extract financial information.

Extract the following data if available:
- Annual salary/income
- Monthly expenses (recurring payments, utilities, etc.)
- Current SIP/mutual fund investments and amounts
- Bank balance and liquid funds
- Home loan details (outstanding amount, interest rate, EMI)
- Direct equity holdings
- Real estate investments
- Life insurance coverage
- Education expenses for children
- Any other relevant financial data

Respond ONLY with a JSON object (no markdown, no backticks) with these exact keys:
{
  "annualSalary": number or null,
  "monthlyExpenses": number or null,
  "sipPortfolio": number or null,
  "monthlySIP": number or null,
  "bankBalance": number or null,
  "homeLoan": number or null,
  "loanRate": number or null,
  "directEquity": number or null,
  "realEstate": number or null,
  "lifeInsurance": number or null,
  "educationCostCurrent": number or null,
  "age": number or null,
  "questions": ["array of follow-up questions for missing critical data"],
  "summary": "brief summary of financial situation"
}

If you can't find a value, use null. Ask specific questions for critical missing data.`
                }
            ];
            
            // Add documents as images
            for (const doc of documents) {
                const mediaType = doc.type.includes('pdf') ? 'application/pdf' : doc.type;
                content.push({
                    type: doc.type.includes('pdf') ? 'document' : 'image',
                    source: {
                        type: 'base64',
                        media_type: mediaType,
                        data: doc.data
                    }
                });
            }
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2000,
                        messages: [{
                            role: 'user',
                            content: content
                        }]
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }
                
                const data = await response.json();
                const textContent = data.content.find(c => c.type === 'text')?.text || '';
                
                // Parse JSON response
                const jsonMatch = textContent.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('Could not parse AI response');
                }
                
                extractedData = JSON.parse(jsonMatch[0]);
                
                // Auto-fill form
                autoFillForm(extractedData);
                
                // Show results
                statusDiv.innerHTML = `<div style="color: #90EE90;">‚úÖ Analysis complete! Form auto-filled.</div>`;
                
                // Show summary and questions
                showAnalysisSummary(extractedData);
                
            } catch (error) {
                throw new Error(`AI Analysis failed: ${error.message}`);
            }
        }
        
        function autoFillForm(data) {
            // Fill in extracted values
            if (data.age) document.getElementById('age').value = data.age;
            if (data.annualSalary) document.getElementById('annualSalary').value = data.annualSalary;
            if (data.monthlyExpenses) document.getElementById('monthlyExpenses').value = data.monthlyExpenses;
            if (data.sipPortfolio) document.getElementById('sipPortfolio').value = data.sipPortfolio;
            if (data.monthlySIP) document.getElementById('monthlySIP').value = data.monthlySIP;
            if (data.bankBalance) document.getElementById('bankBalance').value = data.bankBalance;
            if (data.homeLoan) document.getElementById('homeLoan').value = data.homeLoan;
            if (data.loanRate) document.getElementById('loanRate').value = data.loanRate;
            if (data.directEquity) document.getElementById('directEquity').value = data.directEquity;
            if (data.realEstate) document.getElementById('realEstate').value = data.realEstate;
            if (data.lifeInsurance) document.getElementById('lifeInsurance').value = data.lifeInsurance;
            if (data.educationCostCurrent) document.getElementById('educationCostCurrent').value = data.educationCostCurrent;
            
            // Trigger auto-calculations for derived fields
            updateEmergencyTarget();
            updateInsuranceNeeded();
            
            // Highlight auto-filled fields
            const filledFields = document.querySelectorAll('input[type="number"]');
            filledFields.forEach(field => {
                if (field.value && !field.readOnly) {
                    field.style.background = '#e7ffe7';
                    field.style.borderColor = '#28a745';
                }
            });
        }
        
        function showAnalysisSummary(data) {
            const outputPanel = document.getElementById('outputPanel');
            
            let questionsHTML = '';
            if (data.questions && data.questions.length > 0) {
                questionsHTML = `
                    <div class="alert alert-warning" style="margin-top: 20px;">
                        <strong>ü§î AI needs more information:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            ${data.questions.map(q => `<li style="margin-bottom: 6px;">${q}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            outputPanel.innerHTML = `
                <div class="metric-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <h2>‚úÖ AI Analysis Complete!</h2>
                    <div class="subtitle" style="font-size: 1rem; margin-top: 10px;">${data.summary || 'Documents analyzed and form auto-filled'}</div>
                </div>
                
                <div class="alert alert-success">
                    <strong>üìä Extracted Data:</strong>
                    <div style="margin-top: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;">
                        ${data.annualSalary ? `<div>‚Ä¢ Annual Salary: ‚Çπ${data.annualSalary.toLocaleString()}</div>` : ''}
                        ${data.monthlyExpenses ? `<div>‚Ä¢ Monthly Expenses: ‚Çπ${data.monthlyExpenses.toLocaleString()}</div>` : ''}
                        ${data.sipPortfolio ? `<div>‚Ä¢ SIP Portfolio: ‚Çπ${data.sipPortfolio.toLocaleString()}</div>` : ''}
                        ${data.bankBalance ? `<div>‚Ä¢ Bank Balance: ‚Çπ${data.bankBalance.toLocaleString()}</div>` : ''}
                        ${data.homeLoan ? `<div>‚Ä¢ Home Loan: ‚Çπ${data.homeLoan.toLocaleString()}</div>` : ''}
                        ${data.lifeInsurance ? `<div>‚Ä¢ Life Insurance: ‚Çπ${data.lifeInsurance.toLocaleString()}</div>` : ''}
                    </div>
                </div>
                
                ${questionsHTML}
                
                <div class="action-item high" style="margin-top: 20px;">
                    <strong>üëâ Next Steps:</strong>
                    <p>1. Review the auto-filled values (highlighted in green)</p>
                    <p>2. Fill in any missing required fields</p>
                    <p>3. Answer the AI's questions above if any</p>
                    <p>4. Click "Generate Financial Plan" to see your complete analysis</p>
                </div>
            `;
        }
        
        async function askAIForRecommendations() {
            const apiKey = ANTHROPIC_API_KEY;
            if (!apiKey) {
                alert('Please enter your API key and upload documents first.');
                return;
            }
            
            const inputs = getInputs();
            const yearsToRetirement = inputs.retirementAge - inputs.age;
            
            const prompt = `You are a financial advisor. Based on this profile, provide personalized investment allocation recommendations:

Profile:
- Age: ${inputs.age}, Retirement: ${inputs.retirementAge} (${yearsToRetirement} years)
- Annual Salary: ‚Çπ${inputs.annualSalary}
- Monthly Expenses: ‚Çπ${inputs.monthlyExpenses}
- Current Portfolio: SIP ‚Çπ${inputs.sipPortfolio}, Equity ‚Çπ${inputs.directEquity}, RE ‚Çπ${inputs.realEstate}
- Liabilities: Home Loan ‚Çπ${inputs.homeLoan}
- Risk: ${yearsToRetirement > 20 ? 'High (long horizon)' : yearsToRetirement > 10 ? 'Moderate' : 'Conservative (near retirement)'}

Provide:
1. Recommended allocation percentages for surplus savings (Equity/Real Estate/Debt)
2. Specific investment suggestions (fund types, real estate strategy, etc.)
3. Risk assessment and why this allocation suits their profile
4. 2-3 key action items

Keep response under 300 words, practical and actionable.`;
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                const recommendation = data.content.find(c => c.type === 'text')?.text || '';
                
                return recommendation;
                
            } catch (error) {
                console.error('Error getting AI recommendations:', error);
                return null;
            }
        }
        
        function closeModal() {
            document.getElementById('scoreModal').classList.remove('active');
        }
        
        function showScoreExplanation() {
            document.getElementById('scoreModal').classList.add('active');
        }
        
        // Auto-calculate derived values
        document.addEventListener('input', function(e) {
            if (['monthlyExpenses', 'homeLoan', 'loanRate'].includes(e.target.id)) {
                updateEmergencyTarget();
            }
            if (['annualSalary', 'homeLoan'].includes(e.target.id)) {
                updateInsuranceNeeded();
            }
        });
        
        function updateEmergencyTarget() {
            const monthlyExpenses = parseFloat(document.getElementById('monthlyExpenses').value) || 0;
            const homeLoan = parseFloat(document.getElementById('homeLoan').value) || 0;
            const loanRate = parseFloat(document.getElementById('loanRate').value) || 8.5;
            
            // Only calculate if we have monthly expenses
            if (monthlyExpenses === 0) {
                document.getElementById('emergencyTarget').value = '';
                return;
            }
            
            // Estimate EMI (approximate using simple formula)
            const monthlyRate = loanRate / 12 / 100;
            const estimatedEMI = homeLoan > 0 ? (homeLoan * monthlyRate * 1.2) : 0; // Rough estimate
            
            // 6 months expenses + 12 months EMI
            const emergencyTarget = (monthlyExpenses * 6) + (estimatedEMI * 12);
            document.getElementById('emergencyTarget').value = Math.round(emergencyTarget);
        }
        
        function updateInsuranceNeeded() {
            const annualSalary = parseFloat(document.getElementById('annualSalary').value) || 0;
            const homeLoan = parseFloat(document.getElementById('homeLoan').value) || 0;
            
            // Only calculate if we have annual salary
            if (annualSalary === 0) {
                document.getElementById('insuranceNeeded').value = '';
                return;
            }
            
            // 10x salary + outstanding loans
            const insuranceNeeded = (annualSalary * 10) + homeLoan;
            document.getElementById('insuranceNeeded').value = Math.round(insuranceNeeded);
        }
        
        // Don't initialize derived values on load - they should be empty until user enters data
        
        function getInputs() {
            // Calculate net salary
            const grossSalary = parseFloat(document.getElementById('annualSalary').value);
            let annualSalary;
            if (salaryType === 'gross') {
                annualSalary = grossSalary - calculateIncomeTax(grossSalary);
            } else {
                annualSalary = grossSalary;
            }
            
            // Parse children data
            const childrenAgesStr = (document.getElementById('childrenAges')?.value || '').trim();
            const educationCostsStr = (document.getElementById('educationCosts')?.value || '').trim();
            let childrenAges = childrenAgesStr ? childrenAgesStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n)) : [];
            let educationCosts = educationCostsStr ? educationCostsStr.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n)) : [];
            
            return {
                age: parseFloat(document.getElementById('age').value),
                retirementAge: parseFloat(document.getElementById('retirementAge').value),
                annualSalary,
                monthlySIP: parseFloat(document.getElementById('monthlySIP').value),
                sipStepup: parseFloat(document.getElementById('sipStepup').value) / 100,
                sipPortfolio: parseFloat(document.getElementById('sipPortfolio').value),
                monthlyExpenses: parseFloat(document.getElementById('monthlyExpenses').value),
                homeLoan: parseFloat(document.getElementById('homeLoan').value) || 0,
                loanRate: parseFloat(document.getElementById('loanRate').value) || 8.5,
                homeLoanPrepay: parseFloat(document.getElementById('homeLoanPrepay').value) || 0,
                bankBalance: parseFloat(document.getElementById('bankBalance').value),
                emergencyTarget: parseFloat(document.getElementById('emergencyTarget').value),
                directEquity: parseFloat(document.getElementById('directEquity').value) || 0,
                goldHoldings: parseFloat(document.getElementById('goldHoldings').value) || 0,
                realEstate: parseFloat(document.getElementById('realEstate').value) || 0,
                otherAssets: parseFloat(document.getElementById('otherAssets').value) || 0,
                propertyValue: parseFloat(document.getElementById('propertyValue').value) || 0,
                lifeInsurance: parseFloat(document.getElementById('lifeInsurance').value) || 0,
                insuranceNeeded: parseFloat(document.getElementById('insuranceNeeded').value),
                insurancePremium: parseFloat(document.getElementById('insurancePremium').value) || 0,
                childrenAges,
                educationCosts,
                holidayBudget: parseFloat(document.getElementById('holidayBudget').value) || 0,
                // Hardcoded return assumptions (per PDF - not shown as inputs)
                sipReturn: 0.12,              // 12% SIP/MF return
                directEquityReturn: 0.12,      // 12% direct equity
                realEstateReturn: 0.06,        // 6% real estate appreciation
                liquidReturn: 0.06,            // 6% liquid/debt return
                expenseInflation: 0.07,        // 7% expense inflation
                postRetirementReturn: 0.08     // 8% post-retirement conservative
            };
        }
        
        function calculatePlan() {
            // Validate required fields
            const requiredFields = [
                { id: 'age', name: 'Current Age' },
                { id: 'retirementAge', name: 'Target Retirement Age' },
                { id: 'annualSalary', name: 'Annual Salary' },
                { id: 'monthlySIP', name: 'Monthly SIP Investment' },
                { id: 'sipStepup', name: 'Annual SIP Step-up' },
                { id: 'sipPortfolio', name: 'Current SIP Portfolio' },
                { id: 'monthlyExpenses', name: 'Monthly Living Expenses' },
                { id: 'bankBalance', name: 'Bank Balance + Liquid Funds' }
            ];
            
            const missingFields = [];
            for (const field of requiredFields) {
                const value = document.getElementById(field.id).value;
                if (!value || value === '') {
                    missingFields.push(field.name);
                }
            }
            
            if (missingFields.length > 0) {
                alert('‚ö†Ô∏è Please fill in the following required fields:\n\n' + missingFields.join('\n'));
                return;
            }
            
            const inputs = getInputs();
            const yearsToRetirement = inputs.retirementAge - inputs.age;
            
            // Calculate retirement corpus needed
            const monthlyExpensesAt60 = inputs.monthlyExpenses * Math.pow(1 + inputs.expenseInflation, yearsToRetirement);
            const annualExpensesAt60 = monthlyExpensesAt60 * 12;
            const corpusNeeded = annualExpensesAt60 * 25; // 4% rule
            
            document.getElementById('retirementCorpus').value = Math.round(corpusNeeded);
            
            // Year by year projection
            const projection = [];
            let sipPortfolio = inputs.sipPortfolio;
            let directEquity = inputs.directEquity;
            let goldHoldings = inputs.goldHoldings;
            let realEstate = inputs.realEstate;
            let otherAssets = inputs.otherAssets;
            let liquid = inputs.bankBalance;
            let homeLoan = inputs.homeLoan;
            let monthlySIP = inputs.monthlySIP;
            let currentExpenses = inputs.monthlyExpenses;
            let educationCost = 0; // Will be calculated from children ages/costs
            let holidayCost = inputs.holidayBudget;
            
            for (let year = 0; year < yearsToRetirement; year++) {
                const currentAge = inputs.age + year;
                
                // SIP growth
                const annualSIP = monthlySIP * 12;
                sipPortfolio = sipPortfolio * (1 + inputs.sipReturn) + annualSIP;
                
                // Other portfolio growth
                directEquity *= (1 + inputs.directEquityReturn);
                goldHoldings *= 1.08; // Gold ~8%
                realEstate *= (1 + inputs.realEstateReturn);
                otherAssets *= 1.10; // Other assets ~10%
                liquid *= (1 + inputs.liquidReturn);
                
                // Expenses grow with inflation
                currentExpenses *= (1 + inputs.expenseInflation);
                
                // Multiple children education
                let annualEducation = 0;
                if (inputs.childrenAges && inputs.childrenAges.length > 0) {
                    inputs.childrenAges.forEach((childAge, idx) => {
                        const currentAge = childAge + year;
                        const baseCost = inputs.educationCosts[idx] || 0;
                        const inflatedCost = baseCost * Math.pow(1.08, year);
                        if (currentAge < 18) {
                            annualEducation += inflatedCost;
                        } else if (currentAge >= 18 && currentAge < 22) {
                            annualEducation += inflatedCost * 4;
                        }
                    });
                }
                educationCost = annualEducation; // Education inflation 8%
                holidayCost *= 1.12; // Lifestyle inflation 12%
                
                // Annual deductions
                const annualExpenses = currentExpenses * 12;
                const totalAnnualCost = annualExpenses + educationCost + holidayCost + inputs.insurancePremium;
                
                // Home loan prepayment
                if (homeLoan > 0) {
                    homeLoan = Math.max(0, homeLoan - inputs.homeLoanPrepay);
                }
                
                // Surplus allocation (50% equity, 30% RE, 20% liquid)
                const surplus = (inputs.annualSalary * (1.05 ** year)) - totalAnnualCost - annualSIP;
                if (surplus > 0) {
                    directEquity += surplus * 0.5;
                    realEstate += surplus * 0.3;
                    liquid += surplus * 0.2;
                }
                
                // SIP step-up
                monthlySIP *= (1 + inputs.sipStepup);
                
                projection.push({
                    year: year + 1,
                    age: currentAge + 1,
                    sipPortfolio: Math.round(sipPortfolio),
                    directEquity: Math.round(directEquity),
                    goldHoldings: Math.round(goldHoldings),
                    realEstate: Math.round(realEstate),
                    otherAssets: Math.round(otherAssets),
                    liquid: Math.round(liquid),
                    homeLoan: Math.round(homeLoan),
                    expenses: Math.round(currentExpenses * 12)
                });
            }
            
            const finalYear = projection[projection.length - 1];
            const finalPortfolio = finalYear.sipPortfolio + finalYear.directEquity + finalYear.goldHoldings + finalYear.realEstate + finalYear.otherAssets + finalYear.liquid;
            const gap = finalPortfolio - corpusNeeded;
            const gapPercent = (gap / corpusNeeded) * 100;
            
            // Calculate gaps
            const emergencyGap = Math.max(0, (inputs.emergencyTarget || 0) - inputs.bankBalance);
            const insuranceGap = Math.max(0, (inputs.insuranceNeeded || 0) - inputs.lifeInsurance);
            
            // Calculate health score (handle hidden fields gracefully)
            const portfolioScore = Math.min(40, (finalPortfolio / corpusNeeded) * 40);
            
            // Emergency score: if emergencyTarget is 0 or undefined, give full score if bank balance > 6 months expenses
            const sixMonthsExpenses = inputs.monthlyExpenses * 6;
            const emergencyScore = inputs.emergencyTarget && inputs.emergencyTarget > 0
                ? Math.min(20, (inputs.bankBalance / inputs.emergencyTarget) * 20)
                : Math.min(20, (inputs.bankBalance / sixMonthsExpenses) * 20);
            
            // Insurance score: if insuranceNeeded is 0 or undefined, calculate as 10x annual salary
            const calculatedInsuranceNeed = inputs.annualSalary * 10;
            const insuranceScore = inputs.insuranceNeeded && inputs.insuranceNeeded > 0
                ? Math.min(20, (inputs.lifeInsurance / inputs.insuranceNeeded) * 20)
                : Math.min(20, (inputs.lifeInsurance / calculatedInsuranceNeed) * 20);
            
            const debtScore = Math.min(20, inputs.homeLoan > 0 ? (inputs.homeLoanPrepay > 0 ? 15 : 10) : 20);
            const healthScore = Math.round(portfolioScore + emergencyScore + insuranceScore + debtScore);
            
            currentResults = {
                inputs,
                projection,
                finalPortfolio,
                corpusNeeded,
                gap,
                gapPercent,
                emergencyGap,
                insuranceGap,
                healthScore,
                monthlyExpensesAt60,
                annualExpensesAt60
            };
            
            displayResults('summary');
        }
        
        function formatCurrency(amount) {
            if (amount >= 10000000) {
                return `‚Çπ${(amount / 10000000).toFixed(2)}Cr`;
            } else if (amount >= 100000) {
                return `‚Çπ${(amount / 100000).toFixed(2)}L`;
            } else {
                return `‚Çπ${amount.toLocaleString('en-IN')}`;
            }
        }
        
        function displayResults(tab) {
            if (!currentResults) return;
            
            const results = currentResults;
            const outputPanel = document.getElementById('outputPanel');
            
            // Calculate individual score components for breakdown
            const portfolioScore = Math.min(40, Math.round((results.finalPortfolio / results.corpusNeeded) * 40));
            const sixMonthsExp = results.inputs.monthlyExpenses * 6;
            const emergencyScore = results.inputs.emergencyTarget && results.inputs.emergencyTarget > 0
                ? Math.min(20, Math.round((results.inputs.bankBalance / results.inputs.emergencyTarget) * 20))
                : Math.min(20, Math.round((results.inputs.bankBalance / sixMonthsExp) * 20));
            const calcInsuranceNeed = results.inputs.annualSalary * 10;
            const insuranceScore = results.inputs.insuranceNeeded && results.inputs.insuranceNeeded > 0
                ? Math.min(20, Math.round((results.inputs.lifeInsurance / results.inputs.insuranceNeeded) * 20))
                : Math.min(20, Math.round((results.inputs.lifeInsurance / calcInsuranceNeed) * 20));
            const debtScore = Math.min(20, results.inputs.homeLoan > 0 ? (results.inputs.homeLoanPrepay > 0 ? 15 : 10) : 20);

            // Create tabs
            let content = `
                <div class="metric-card">
                    <h2>Financial Health Score <button class="explain-btn" onclick="showScoreExplanation()">How is this calculated?</button></h2>
                    <div class="value">${results.healthScore}/100</div>
                    <div class="subtitle">${
                        results.healthScore >= 90 ? 'üéâ Excellent - On track for early retirement!' :
                        results.healthScore >= 75 ? '‚úÖ Good - Retirement secured, minor tweaks needed' :
                        results.healthScore >= 60 ? '‚ö†Ô∏è Fair - On track but gaps need attention' :
                        'üî¥ Needs Work - Immediate action required'
                    }</div>
                </div>

                <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #0f4c75; margin-bottom: 16px; font-size: 1.1rem;">üìä Score Breakdown</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid ${portfolioScore >= 35 ? '#28a745' : portfolioScore >= 20 ? '#ffc107' : '#dc3545'};">
                            <div style="font-weight: 600; color: #495057; margin-bottom: 4px;">Portfolio Performance</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #667eea;">${portfolioScore}/40</div>
                            <div style="font-size: 0.8rem; color: #6c757d;">${portfolioScore >= 35 ? 'Excellent' : portfolioScore >= 20 ? 'Good' : 'Needs Work'}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid ${emergencyScore >= 15 ? '#28a745' : emergencyScore >= 10 ? '#ffc107' : '#dc3545'};">
                            <div style="font-weight: 600; color: #495057; margin-bottom: 4px;">Emergency Fund</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #667eea;">${emergencyScore}/20</div>
                            <div style="font-size: 0.8rem; color: #6c757d;">${emergencyScore >= 15 ? 'Adequate' : emergencyScore >= 10 ? 'Building' : 'Critical'}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid ${insuranceScore >= 15 ? '#28a745' : insuranceScore >= 10 ? '#ffc107' : '#dc3545'};">
                            <div style="font-weight: 600; color: #495057; margin-bottom: 4px;">Insurance Protection</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #667eea;">${insuranceScore}/20</div>
                            <div style="font-size: 0.8rem; color: #6c757d;">${insuranceScore >= 15 ? 'Well covered' : insuranceScore >= 10 ? 'Partial' : 'Insufficient'}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid ${debtScore >= 15 ? '#28a745' : debtScore >= 10 ? '#ffc107' : '#dc3545'};">
                            <div style="font-weight: 600; color: #495057; margin-bottom: 4px;">Debt Management</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #667eea;">${debtScore}/20</div>
                            <div style="font-size: 0.8rem; color: #6c757d;">${debtScore >= 15 ? 'Excellent' : debtScore >= 10 ? 'Good' : 'Needs attention'}</div>
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab ${tab === 'summary' ? 'active' : ''}" onclick="displayResults('summary')">üìä Summary</div>
                    <div class="tab ${tab === 'retirement' ? 'active' : ''}" onclick="displayResults('retirement')">üèñÔ∏è Retirement</div>
                    <div class="tab ${tab === 'gaps' ? 'active' : ''}" onclick="displayResults('gaps')">‚ö†Ô∏è Gaps</div>
                    <div class="tab ${tab === 'actions' ? 'active' : ''}" onclick="displayResults('actions')">‚úÖ Actions</div>
                    <div class="tab ${tab === 'scenarios' ? 'active' : ''}" onclick="displayResults('scenarios')">üîÑ Scenarios</div>
                    <div class="tab ${tab === 'ai-advisor' ? 'active' : ''}" onclick="displayResults('ai-advisor')">ü§ñ AI Advisor</div>
                </div>
                
                <div id="tabContent"></div>
            `;
            
            outputPanel.innerHTML = content;
            
            const tabContent = document.getElementById('tabContent');
            
            if (tab === 'summary') {
                const totalAssets = results.inputs.sipPortfolio + results.inputs.directEquity + 
                                  results.inputs.realEstate + results.inputs.bankBalance;
                const totalLiabilities = results.inputs.homeLoan;
                const netWorth = totalAssets - totalLiabilities;
                
                // Calculate annual net savings available for allocation
                const annualSalary = results.inputs.annualSalary;
                const annualExpenses = results.inputs.monthlyExpenses * 12;
                const annualSIP = results.inputs.monthlySIP * 12;
                const annualInsurance = results.inputs.insurancePremium;
                
                // Calculate current annual education from children data
                let annualEducation = 0;
                if (results.inputs.educationCosts && results.inputs.educationCosts.length > 0) {
                    annualEducation = results.inputs.educationCosts.reduce((sum, cost) => sum + (cost || 0), 0);
                }
                
                const annualHoliday = results.inputs.holidayBudget;
                const annualLoanPrepay = results.inputs.homeLoanPrepay;
                
                // Estimate EMI using proper formula: P * r * (1+r)^n / ((1+r)^n - 1)
                const loanRateDecimal = results.inputs.loanRate / 100; // Convert 8.5 to 0.085
                const monthlyRate = loanRateDecimal / 12; // Monthly rate
                const loanTenureMonths = 240; // Assume 20 year tenure
                let estimatedEMI = 0;
                if (results.inputs.homeLoan > 0 && monthlyRate > 0) {
                    const compoundFactor = Math.pow(1 + monthlyRate, loanTenureMonths);
                    estimatedEMI = results.inputs.homeLoan * monthlyRate * compoundFactor / (compoundFactor - 1);
                }
                const annualEMI = estimatedEMI * 12;
                
                const totalFixedCommitments = annualExpenses + annualSIP + annualInsurance + 
                                            annualEducation + annualHoliday + annualLoanPrepay + annualEMI;
                const netSavingsAvailable = annualSalary - totalFixedCommitments;
                
                // Recommended allocation (50% equity, 30% real estate, 20% debt/liquid)
                const recommendedEquity = netSavingsAvailable * 0.5;
                const recommendedRealEstate = netSavingsAvailable * 0.3;
                const recommendedDebt = netSavingsAvailable * 0.2;
                
                tabContent.innerHTML = `
                    <h2 class="section-title">Current Financial Position</h2>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <h4>Total Assets</h4>
                            <div class="amount" style="color: #28a745">${formatCurrency(totalAssets)}</div>
                            <div class="description">Current portfolio</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Total Liabilities</h4>
                            <div class="amount" style="color: #dc3545">${formatCurrency(totalLiabilities)}</div>
                            <div class="description">Outstanding loans</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Net Worth</h4>
                            <div class="amount" style="color: #0f4c75">${formatCurrency(netWorth)}</div>
                            <div class="description">Assets - Liabilities</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Years to Retirement</h4>
                            <div class="amount">${results.inputs.retirementAge - results.inputs.age}</div>
                            <div class="description">Years of wealth building</div>
                        </div>
                    </div>

                    <h3 class="section-title" style="font-size: 1.2rem; margin-top: 25px;">Monthly Cashflow</h3>

                    <div class="results-grid">
                        <div class="result-card" style="border-color: #28a745; background: #f0fff4;">
                            <h4>Monthly In-Hand Income</h4>
                            <div class="amount" style="color: #28a745">${formatCurrency(results.inputs.annualSalary / 12)}</div>
                            <div class="description">Net take-home</div>
                        </div>

                        <div class="result-card" style="border-color: #dc3545; background: #fff5f5;">
                            <h4>Home Loan EMI</h4>
                            <div class="amount" style="color: #dc3545">-${formatCurrency(estimatedEMI)}</div>
                            <div class="description">Monthly EMI</div>
                        </div>

                        <div class="result-card" style="border-color: #ffc107; background: #fffef5;">
                            <h4>Insurance Premiums</h4>
                            <div class="amount" style="color: #d39e00">-${formatCurrency(results.inputs.insurancePremium / 12)}</div>
                            <div class="description">Life insurance</div>
                        </div>

                        <div class="result-card" style="border-color: #667eea; background: #f0f4ff;">
                            <h4>MF SIPs</h4>
                            <div class="amount" style="color: #667eea">-${formatCurrency(results.inputs.monthlySIP)}</div>
                            <div class="description">Monthly investments</div>
                        </div>

                        <div class="result-card" style="border-color: #0f4c75; background: #e7f3ff;">
                            <h4>Available for Expenses</h4>
                            <div class="amount" style="color: #0f4c75">${formatCurrency((results.inputs.annualSalary / 12) - estimatedEMI - (results.inputs.insurancePremium / 12) - results.inputs.monthlySIP)}</div>
                            <div class="description">After fixed commitments</div>
                        </div>

                        <div class="result-card" style="border-color: ${netSavingsAvailable >= 0 ? '#28a745' : '#dc3545'}; background: ${netSavingsAvailable >= 0 ? '#f0fff4' : '#fff5f5'};">
                            <h4>Monthly Surplus</h4>
                            <div class="amount" style="color: ${netSavingsAvailable >= 0 ? '#28a745' : '#dc3545'}">${formatCurrency(netSavingsAvailable / 12)}</div>
                            <div class="description">${netSavingsAvailable >= 0 ? 'For additional investment' : 'Deficit - needs attention'}</div>
                        </div>
                    </div>

                    <h3 class="section-title" style="font-size: 1.2rem; margin-top: 25px;">Current Asset Breakdown</h3>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <h4>SIP/Mutual Funds</h4>
                            <div class="amount">${formatCurrency(results.inputs.sipPortfolio)}</div>
                            <div class="description">${((results.inputs.sipPortfolio / totalAssets) * 100).toFixed(0)}% of assets</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Direct Equity</h4>
                            <div class="amount">${formatCurrency(results.inputs.directEquity)}</div>
                            <div class="description">${((results.inputs.directEquity / totalAssets) * 100).toFixed(0)}% of assets</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Real Estate</h4>
                            <div class="amount">${formatCurrency(results.inputs.realEstate)}</div>
                            <div class="description">${((results.inputs.realEstate / totalAssets) * 100).toFixed(0)}% of assets</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Cash & Liquid</h4>
                            <div class="amount">${formatCurrency(results.inputs.bankBalance)}</div>
                            <div class="description">${((results.inputs.bankBalance / totalAssets) * 100).toFixed(0)}% of assets</div>
                        </div>
                    </div>
                    
                    ${netSavingsAvailable > 0 ? `
                        <h3 class="section-title" style="font-size: 1.2rem; margin-top: 25px;">üí∞ Recommended Allocation for Surplus Savings</h3>
                        
                        <div class="alert alert-success">
                            <strong>Annual Net Savings Available: ${formatCurrency(netSavingsAvailable)}</strong>
                            <p style="font-size: 0.85rem; margin-top: 6px;">After all expenses (‚Çπ${formatCurrency(annualExpenses)}), SIPs (‚Çπ${formatCurrency(annualSIP)}), EMIs (‚Çπ${formatCurrency(annualEMI)}), loan prepayment (‚Çπ${formatCurrency(annualLoanPrepay)}), insurance (‚Çπ${formatCurrency(annualInsurance)}), education (‚Çπ${formatCurrency(annualEducation)}), and holidays (‚Çπ${formatCurrency(annualHoliday)})</p>
                        </div>
                        
                        <div class="results-grid">
                            <div class="result-card" style="border-color: #667eea; background: #f0f4ff;">
                                <h4>üéØ Direct Equity (50%)</h4>
                                <div class="amount" style="color: #667eea">${formatCurrency(recommendedEquity)}/year</div>
                                <div class="description">Higher growth potential</div>
                            </div>
                            
                            <div class="result-card" style="border-color: #28a745; background: #f0fff4;">
                                <h4>üèòÔ∏è Real Estate (30%)</h4>
                                <div class="amount" style="color: #28a745">${formatCurrency(recommendedRealEstate)}/year</div>
                                <div class="description">Stable appreciation</div>
                            </div>
                            
                            <div class="result-card" style="border-color: #ffc107; background: #fffef5;">
                                <h4>üíº Debt/Liquid (20%)</h4>
                                <div class="amount" style="color: #d39e00">${formatCurrency(recommendedDebt)}/year</div>
                                <div class="description">Safety & liquidity</div>
                            </div>
                        </div>
                        
                        <div class="action-item high" style="margin-top: 16px;">
                            <strong>Why This Mix?</strong>
                            <p>This 50-30-20 allocation balances growth (equity), stability (real estate), and safety (debt). You can experiment with different allocations in the "Scenarios" tab to see the impact on your retirement corpus.</p>
                            <button class="upload-btn" onclick="getAIAllocationAdvice()" style="margin-top: 12px; width: auto; padding: 10px 20px; font-size: 0.9rem;">
                                ü§ñ Get AI Personalized Allocation Advice
                            </button>
                            <div id="aiAdvice" style="margin-top: 12px;"></div>
                        </div>
                    ` : netSavingsAvailable < 0 ? `
                        <div class="alert alert-danger" style="margin-top: 25px;">
                            <strong>‚ö†Ô∏è Monthly Deficit: ${formatCurrency(Math.abs(netSavingsAvailable))}</strong>
                            <p>Your expenses and commitments exceed your income. You need to either increase income or reduce expenses to avoid depleting savings.</p>
                        </div>
                    ` : ''}
                    
                    <h3 class="section-title" style="font-size: 1.2rem; margin-top: 25px;">Retirement Projection</h3>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <h4>Portfolio at ${results.inputs.retirementAge}</h4>
                            <div class="amount">${formatCurrency(results.finalPortfolio)}</div>
                            <div class="description">Total wealth</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Corpus Needed</h4>
                            <div class="amount">${formatCurrency(results.corpusNeeded)}</div>
                            <div class="description">25 years retirement</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Surplus/Gap</h4>
                            <div class="amount" style="color: ${results.gap >= 0 ? '#28a745' : '#dc3545'}">${formatCurrency(Math.abs(results.gap))}</div>
                            <div class="description">${results.gap >= 0 ? 'Surplus' : 'Shortfall'} (${Math.abs(results.gapPercent).toFixed(1)}%)</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Monthly Expenses at ${results.inputs.retirementAge}</h4>
                            <div class="amount">${formatCurrency(results.monthlyExpensesAt60)}</div>
                            <div class="description">After inflation</div>
                        </div>
                    </div>

                    ${results.gap >= 0 ? `
                        <div class="alert alert-success">
                            <strong>üéâ Retirement Status: ON TRACK!</strong>
                            <p>Surplus of ${formatCurrency(results.gap)} (${results.gapPercent.toFixed(1)}% above target)</p>
                            <p>You're projected to exceed your retirement needs. Consider early retirement or higher lifestyle.</p>
                        </div>
                    ` : `
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Retirement Status: NEEDS ADJUSTMENT</strong>
                            <p>Shortfall of ${formatCurrency(Math.abs(results.gap))} (${Math.abs(results.gapPercent).toFixed(1)}%)</p>
                            <p>Increase SIP, extend working years, or reduce retirement expenses to close this gap.</p>
                        </div>
                    `}
                    
                    <!-- Excel/PDF Export - Disabled for now
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="calculate-btn" onclick="downloadExcelReport()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                            üìä Download Excel Report
                        </button>
                        <button class="calculate-btn" onclick="downloadPDFReport()" style="flex: 1; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                            üìÑ Download PDF Report
                        </button>
                    </div>
                    -->
                `;
            } else if (tab === 'retirement') {
                const finalYear = results.projection[results.projection.length - 1];
                tabContent.innerHTML = `
                    <h2 class="section-title">Retirement Projection</h2>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <h4>Portfolio at ${results.inputs.retirementAge}</h4>
                            <div class="amount">${formatCurrency(results.finalPortfolio)}</div>
                            <div class="description">Total wealth</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Corpus Needed</h4>
                            <div class="amount">${formatCurrency(results.corpusNeeded)}</div>
                            <div class="description">25 years retirement</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Monthly Expenses</h4>
                            <div class="amount">${formatCurrency(results.monthlyExpensesAt60)}</div>
                            <div class="description">At age ${results.inputs.retirementAge}</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Annual Expenses</h4>
                            <div class="amount">${formatCurrency(results.annualExpensesAt60)}</div>
                            <div class="description">Per year</div>
                        </div>
                    </div>

                    <h3 class="section-title" style="font-size: 1.2rem;">Portfolio Breakdown</h3>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <h4>SIP/Mutual Funds</h4>
                            <div class="amount">${formatCurrency(finalYear.sipPortfolio)}</div>
                            <div class="description">${((finalYear.sipPortfolio / results.finalPortfolio) * 100).toFixed(0)}%</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Direct Equity</h4>
                            <div class="amount">${formatCurrency(finalYear.directEquity)}</div>
                            <div class="description">${((finalYear.directEquity / results.finalPortfolio) * 100).toFixed(0)}%</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Real Estate</h4>
                            <div class="amount">${formatCurrency(finalYear.realEstate)}</div>
                            <div class="description">${((finalYear.realEstate / results.finalPortfolio) * 100).toFixed(0)}%</div>
                        </div>
                        
                        <div class="result-card">
                            <h4>Liquid/Debt</h4>
                            <div class="amount">${formatCurrency(finalYear.liquid)}</div>
                            <div class="description">${((finalYear.liquid / results.finalPortfolio) * 100).toFixed(0)}%</div>
                        </div>
                    </div>
                `;
            } else if (tab === 'gaps') {
                const emergencyBankAccount = results.inputs.emergencyTarget * 0.4;
                const emergencyLiquidFunds = results.inputs.emergencyTarget * 0.4;
                const emergencyDebtFunds = results.inputs.emergencyTarget * 0.2;
                
                tabContent.innerHTML = `
                    <h2 class="section-title">Critical Gaps Analysis</h2>
                    
                    ${results.emergencyGap > 0 ? `
                        <div class="alert alert-danger">
                            <strong>üî¥ URGENT: Emergency Fund Gap</strong>
                            <p>Current: ${formatCurrency(results.inputs.bankBalance)} | Target: ${formatCurrency(results.inputs.emergencyTarget)}</p>
                            <p><strong>Gap: ${formatCurrency(results.emergencyGap)} (${((results.emergencyGap / results.inputs.emergencyTarget) * 100).toFixed(0)}%)</strong></p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(results.inputs.bankBalance / results.inputs.emergencyTarget) * 100}%">
                                    ${((results.inputs.bankBalance / results.inputs.emergencyTarget) * 100).toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-item high" style="margin-top: 16px;">
                            <strong>üí° Emergency Fund is NOT Just Cash in Bank - It's a Strategic 3-Layer Defense</strong>
                            <p style="margin-top: 8px;"><strong>Recommended ${formatCurrency(results.inputs.emergencyTarget)} split:</strong></p>
                            <p style="margin-top: 8px;">
                                <strong>Layer 1 (40%): Savings Bank Account - ${formatCurrency(emergencyBankAccount)}</strong><br>
                                Instant access for immediate emergencies. Keep in regular savings account earning 3-4%. Available within minutes via UPI/ATM.
                            </p>
                            <p style="margin-top: 8px;">
                                <strong>Layer 2 (40%): Liquid Mutual Funds - ${formatCurrency(emergencyLiquidFunds)}</strong><br>
                                Invest in liquid funds (HDFC Liquid, ICICI Pru Liquid, etc.). Returns: 6-7%. Money available in 1 business day. Better than savings account, still very liquid.
                            </p>
                            <p style="margin-top: 8px;">
                                <strong>Layer 3 (20%): Ultra-Short Debt Funds - ${formatCurrency(emergencyDebtFunds)}</strong><br>
                                Invest in ultra-short debt funds. Returns: 7-8%. Money available in 3-5 business days. Highest returns in emergency corpus, for non-urgent emergencies.
                            </p>
                            <p style="margin-top: 12px; font-weight: 600;">
                                Why This Works: Balances instant access (bank), quick access (liquid funds), and better returns (debt funds). Don't keep everything in savings account earning 3%!
                            </p>
                        </div>
                    ` : `
                        <div class="alert alert-success">
                            <strong>‚úÖ Emergency Fund: Adequate</strong>
                            <p>You have ${formatCurrency(results.inputs.bankBalance)} in emergency funds (${((results.inputs.bankBalance / results.inputs.emergencyTarget) * 100).toFixed(0)}% of target)</p>
                        </div>
                        
                        <div class="action-item high" style="margin-top: 16px;">
                            <strong>üí° Optimize Your Emergency Fund Allocation</strong>
                            <p style="margin-top: 8px;">You have adequate emergency funds, but make sure it's allocated strategically:</p>
                            <p style="margin-top: 8px;">
                                <strong>Recommended ${formatCurrency(results.inputs.emergencyTarget)} split:</strong><br>
                                ‚Ä¢ 40% in Savings Bank (${formatCurrency(emergencyBankAccount)}) - Instant access<br>
                                ‚Ä¢ 40% in Liquid Mutual Funds (${formatCurrency(emergencyLiquidFunds)}) - 1-day access, 6-7% returns<br>
                                ‚Ä¢ 20% in Ultra-Short Debt Funds (${formatCurrency(emergencyDebtFunds)}) - 3-5 day access, 7-8% returns
                            </p>
                            <p style="margin-top: 8px;">This beats keeping everything in a savings account at 3-4% while maintaining adequate liquidity!</p>
                        </div>
                    `}

                    ${results.insuranceGap > 0 ? `
                        <div class="alert alert-danger" style="margin-top: 18px;">
                            <strong>üî¥ URGENT: Life Insurance Gap</strong>
                            <p>Current: ${formatCurrency(results.inputs.lifeInsurance)} | Needed: ${formatCurrency(results.inputs.insuranceNeeded)}</p>
                            <p><strong>Gap: ${formatCurrency(results.insuranceGap)} (${((results.insuranceGap / results.inputs.insuranceNeeded) * 100).toFixed(0)}%)</strong></p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(results.inputs.lifeInsurance / results.inputs.insuranceNeeded) * 100}%">
                                    ${((results.inputs.lifeInsurance / results.inputs.insuranceNeeded) * 100).toFixed(0)}%
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="alert alert-success" style="margin-top: 18px;">
                            <strong>‚úÖ Life Insurance: Adequate</strong>
                            <p>You have ${formatCurrency(results.inputs.lifeInsurance)} in life insurance coverage (${((results.inputs.lifeInsurance / results.inputs.insuranceNeeded) * 100).toFixed(0)}% of recommended)</p>
                        </div>
                    `}

                    ${results.emergencyGap > 0 || results.insuranceGap > 0 ? `
                        <h3 class="section-title" style="font-size: 1.2rem; margin-top: 25px;">Why These Matter</h3>
                        
                        <div class="action-list">
                            ${results.emergencyGap > 0 ? `
                                <div class="action-item urgent">
                                    <strong>Emergency Fund Risk</strong>
                                    <p>Without adequate emergency fund, a medical crisis or job loss could force you to sell long-term investments at market lows, permanently destroying wealth. Build this FIRST before aggressive investing.</p>
                                </div>
                            ` : ''}

                            ${results.insuranceGap > 0 ? `
                                <div class="action-item urgent">
                                    <strong>Life Insurance Risk</strong>
                                    <p>If something happened to you, your family would struggle with ${formatCurrency(results.inputs.homeLoan)} loan, lost income of ${formatCurrency(results.inputs.annualSalary)}/year, and ongoing expenses. Term insurance is cheap protection.</p>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                `;
            } else if (tab === 'actions') {
                tabContent.innerHTML = `
                    <h2 class="section-title">Prioritized Action Plan</h2>
                    
                    <div class="action-list">
                        <h3 style="margin-bottom: 12px; color: #dc3545;">üî¥ URGENT (Next 30 Days)</h3>
                        
                        ${results.insuranceGap > 0 ? `
                            <div class="action-item urgent">
                                <strong>1. Get Life Insurance Quotes</strong>
                                <p>Get quotes from 3 companies for ${formatCurrency(results.insuranceGap)} additional coverage. Compare premiums and claim settlement ratios. Online term plans are cheapest.</p>
                            </div>
                        ` : ''}

                        ${results.emergencyGap > 0 ? `
                            <div class="action-item urgent">
                                <strong>2. Start Emergency Fund</strong>
                                <p>Open liquid fund account and start building ${formatCurrency(results.inputs.emergencyTarget)} emergency corpus. Allocate ${formatCurrency(results.emergencyGap / 12)}/month for 12 months.</p>
                            </div>
                        ` : ''}

                        ${results.inputs.homeLoan > 0 && results.inputs.homeLoanPrepay > 0 ? `
                            <div class="action-item urgent">
                                <strong>3. Set Up Loan Prepayment</strong>
                                <p>Visit bank and setup ${formatCurrency(results.inputs.homeLoanPrepay)} annual prepayment mandate. At ${(results.inputs.loanRate * 100).toFixed(1)}% interest, prepayment has guaranteed ROI higher than most investments.</p>
                            </div>
                        ` : ''}
                    </div>

                    <div class="action-list">
                        <h3 style="margin-bottom: 12px; color: #ffc107;">üü° HIGH PRIORITY (Ongoing)</h3>
                        
                        <div class="action-item high">
                            <strong>Continue SIP Discipline</strong>
                            <p>Maintain ${formatCurrency(results.inputs.monthlySIP)}/month SIP with ${(results.inputs.sipStepup * 100).toFixed(0)}% annual step-up. Market timing doesn't work - consistency does.</p>
                        </div>

                        <div class="action-item high">
                            <strong>Tax Optimization</strong>
                            <p>Maximize 80C (‚Çπ1.5L), 80D (‚Çπ50K for health), 80CCD(1B) (‚Çπ50K NPS). At 30% tax bracket, potential savings: ‚Çπ3-5L/year. Free money!</p>
                        </div>

                        <div class="action-item high">
                            <strong>Diversify Surplus Cash</strong>
                            <p>Any surplus beyond SIP: allocate 50% direct equity (${(results.inputs.directEquityReturn * 100).toFixed(0)}%), 30% real estate (${(results.inputs.realEstateReturn * 100).toFixed(0)}%), 20% liquid/debt (${(results.inputs.liquidReturn * 100).toFixed(0)}%). Don't keep cash idle.</p>
                        </div>

                        <div class="action-item high">
                            <strong>Review Every 6 Months</strong>
                            <p>Review portfolio performance, rebalance if needed, adjust SIP amounts based on salary hikes, check if on track for goals. Set calendar reminder.</p>
                        </div>
                    </div>
                `;
            } else if (tab === 'scenarios') {
                // Calculate current net savings
                const annualSalary = results.inputs.annualSalary;
                const annualExpenses = results.inputs.monthlyExpenses * 12;
                const annualSIP = results.inputs.monthlySIP * 12;
                // Proper EMI calculation
                const loanRateDecimal2 = results.inputs.loanRate / 100;
                const monthlyRate = loanRateDecimal2 / 12;
                const loanTenureMonths2 = 240;
                let estimatedEMI = 0;
                if (results.inputs.homeLoan > 0 && monthlyRate > 0) {
                    const cf = Math.pow(1 + monthlyRate, loanTenureMonths2);
                    estimatedEMI = results.inputs.homeLoan * monthlyRate * cf / (cf - 1);
                }
                const annualEMI = estimatedEMI * 12;
                
                // Calculate current annual education from children data
                let annualEducation = 0;
                if (results.inputs.educationCosts && results.inputs.educationCosts.length > 0) {
                    annualEducation = results.inputs.educationCosts.reduce((sum, cost) => sum + (cost || 0), 0);
                }
                
                const totalFixedCommitments = annualExpenses + annualSIP + results.inputs.insurancePremium + 
                                            annualEducation + results.inputs.holidayBudget + 
                                            results.inputs.homeLoanPrepay + annualEMI;
                const netSavingsAvailable = annualSalary - totalFixedCommitments;
                
                // Build cashflow summary
                const monthlySalary = results.inputs.annualSalary / 12;
                const monthlyExp = results.inputs.monthlyExpenses;
                const monthlyEMI = estimatedEMI;
                const monthlySIP = results.inputs.monthlySIP;
                const monthlySurplus = netSavingsAvailable / 12;

                // Build year-by-year table rows
                let yearByYearRows = '';
                results.projection.forEach((p, idx) => {
                    if (idx % 2 === 0 || idx === results.projection.length - 1) { // Show every 2nd year + last year
                        const totalPortfolio = p.sipPortfolio + p.directEquity + p.realEstate + p.liquid;
                        yearByYearRows += `
                            <tr style="background: ${idx === results.projection.length - 1 ? '#f0f4ff' : (idx % 4 === 0 ? '#f8f9fa' : 'white')};">
                                <td style="padding: 8px; border: 1px solid #dee2e6; font-weight: ${idx === results.projection.length - 1 ? '700' : '400'};">${p.year}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${p.age}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${formatCurrency(p.sipPortfolio)}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${formatCurrency(p.directEquity)}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${formatCurrency(p.realEstate)}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${formatCurrency(p.liquid)}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6; color: ${p.homeLoan > 0 ? '#dc3545' : '#28a745'};">${p.homeLoan > 0 ? formatCurrency(p.homeLoan) : 'Paid Off'}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6; font-weight: 600; color: #667eea;">${formatCurrency(totalPortfolio)}</td>
                            </tr>
                        `;
                    }
                });

                tabContent.innerHTML = `
                    <h2 class="section-title">Scenario Planning & Projections</h2>

                    <div class="alert alert-success" style="margin-bottom: 20px;">
                        <strong>üìä Monthly Surplus Summary</strong>
                        <div style="margin-top: 10px; font-size: 0.9rem;">
                            <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                                <div>Monthly Income: <strong>${formatCurrency(monthlySalary)}</strong></div>
                                <div>Living Expenses: <strong>-${formatCurrency(monthlyExp)}</strong></div>
                                <div>Home Loan EMI: <strong>-${formatCurrency(monthlyEMI)}</strong></div>
                                <div>MF SIPs: <strong>-${formatCurrency(monthlySIP)}</strong></div>
                                <div style="color: ${monthlySurplus >= 0 ? '#28a745' : '#dc3545'}; font-weight: 700;">
                                    Monthly Surplus: <strong>${formatCurrency(monthlySurplus)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="variables-panel">
                        <h3>üîß Adjust Investment Return Assumptions</h3>
                        <p style="font-size: 0.85rem; color: #6c757d; margin-bottom: 16px;">
                            Modify expected returns to see how different market scenarios affect your retirement corpus.
                        </p>

                        <div class="variable-controls">
                            <div class="variable-item">
                                <label>Equity/MF Returns (%)</label>
                                <input type="number" id="scenario_equity_return" value="12" min="5" max="20" step="1">
                            </div>

                            <div class="variable-item">
                                <label>Real Estate Returns (%)</label>
                                <input type="number" id="scenario_re_return" value="6" min="2" max="15" step="1">
                            </div>

                            <div class="variable-item">
                                <label>Debt/Liquid Returns (%)</label>
                                <input type="number" id="scenario_debt_return" value="6" min="3" max="10" step="0.5">
                            </div>

                            <div class="variable-item">
                                <label>Salary Growth (%)</label>
                                <input type="number" id="scenario_salary_growth" value="5" min="0" max="15" step="1">
                            </div>
                        </div>

                        <button class="calculate-btn" onclick="recalculateScenario()" style="margin-top: 16px; padding: 12px; font-size: 0.95rem;">
                            üîÑ Recalculate with New Assumptions
                        </button>
                    </div>

                    <div class="variables-panel" style="margin-top: 20px;">
                        <h3>üéØ Surplus Allocation Mix</h3>
                        <p style="font-size: 0.85rem; color: #6c757d; margin-bottom: 16px;">
                            You have <strong>${formatCurrency(netSavingsAvailable)}/year</strong> in surplus savings.
                            Adjust how you want to allocate it:
                        </p>

                        <div class="variable-controls">
                            <div class="variable-item">
                                <label>Direct Equity (%)</label>
                                <input type="number" id="alloc_equity" value="50" min="0" max="100" step="5" onchange="updateAllocationTotal()">
                            </div>

                            <div class="variable-item">
                                <label>Real Estate (%)</label>
                                <input type="number" id="alloc_realestate" value="30" min="0" max="100" step="5" onchange="updateAllocationTotal()">
                            </div>

                            <div class="variable-item">
                                <label>Debt/Liquid (%)</label>
                                <input type="number" id="alloc_debt" value="20" min="0" max="100" step="5" onchange="updateAllocationTotal()">
                            </div>

                            <div class="variable-item">
                                <label>Total</label>
                                <input type="number" id="alloc_total" value="100" readonly style="background: #e7f3ff; font-weight: 600;">
                            </div>
                        </div>

                        <div id="allocationWarning" style="display: none;" class="alert alert-warning" style="margin-top: 16px;">
                            <strong>‚ö†Ô∏è Warning:</strong>
                            <p>Total allocation must equal 100%. Current total: <span id="currentTotal">100</span>%</p>
                        </div>

                        <div class="results-grid" style="margin-top: 16px;">
                            <div class="result-card">
                                <h4>Annual Direct Equity</h4>
                                <div class="amount" id="preview_equity">${formatCurrency(netSavingsAvailable * 0.5)}</div>
                                <div class="description">@ 12% returns</div>
                            </div>

                            <div class="result-card">
                                <h4>Annual Real Estate</h4>
                                <div class="amount" id="preview_realestate">${formatCurrency(netSavingsAvailable * 0.3)}</div>
                                <div class="description">@ 6% returns</div>
                            </div>

                            <div class="result-card">
                                <h4>Annual Debt/Liquid</h4>
                                <div class="amount" id="preview_debt">${formatCurrency(netSavingsAvailable * 0.2)}</div>
                                <div class="description">@ 6% returns</div>
                            </div>
                        </div>
                    </div>

                    <h3 class="section-title" style="font-size: 1.2rem; margin-top: 25px;">üìà Year-by-Year Projection</h3>
                    <p style="color: #6c757d; margin-bottom: 16px;">Projected portfolio growth until retirement age ${results.inputs.retirementAge}:</p>

                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #0f4c75 0%, #1b6ca8 100%); color: white;">
                                    <th style="padding: 10px; border: 1px solid #0f4c75;">Year</th>
                                    <th style="padding: 10px; border: 1px solid #0f4c75;">Age</th>
                                    <th style="padding: 10px; border: 1px solid #0f4c75;">SIP/MF</th>
                                    <th style="padding: 10px; border: 1px solid #0f4c75;">Direct Equity</th>
                                    <th style="padding: 10px; border: 1px solid #0f4c75;">Real Estate</th>
                                    <th style="padding: 10px; border: 1px solid #0f4c75;">Liquid/Debt</th>
                                    <th style="padding: 10px; border: 1px solid #0f4c75;">Home Loan</th>
                                    <th style="padding: 10px; border: 1px solid #0f4c75;">Total Portfolio</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${yearByYearRows}
                            </tbody>
                        </table>
                    </div>

                    <div id="scenarioResults" style="margin-top: 25px;">
                        <div class="alert ${results.gap >= 0 ? 'alert-success' : 'alert-warning'}">
                            <strong>${results.gap >= 0 ? '‚úÖ Retirement Target: ACHIEVABLE' : '‚ö†Ô∏è Retirement Target: NEEDS ATTENTION'}</strong>
                            <p>Portfolio at ${results.inputs.retirementAge}: <strong>${formatCurrency(results.finalPortfolio)}</strong></p>
                            <p>Corpus Needed: <strong>${formatCurrency(results.corpusNeeded)}</strong></p>
                            <p style="font-weight: 700; color: ${results.gap >= 0 ? '#28a745' : '#dc3545'};">
                                ${results.gap >= 0 ? 'Surplus' : 'Shortfall'}: ${formatCurrency(Math.abs(results.gap))} (${Math.abs(results.gapPercent).toFixed(1)}%)
                            </p>
                        </div>
                    </div>
                `;

                // Initialize allocation preview
                updateAllocationPreview(netSavingsAvailable);
            } else if (tab === 'ai-advisor') {
                tabContent.innerHTML = `
                    <h2 class="section-title">ü§ñ AI Financial Advisor</h2>
                    <p style="margin-bottom: 20px; color: #6c757d;">Ask anything about your financial plan, investment strategies, or specific scenarios.</p>
                    
                    <div class="alert alert-success" style="background: #f0f4ff; border-color: #667eea;">
                        <strong>üí° Example Questions You Can Ask:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px; font-size: 0.9rem;">
                            <li>Should I prioritize loan prepayment or increase my SIP?</li>
                            <li>What happens if I retire 5 years early?</li>
                            <li>How much life insurance do I really need and why?</li>
                            <li>What's the best way to invest my bonus this year?</li>
                            <li>Should I buy another property or invest in equities?</li>
                        </ul>
                    </div>
                    
                    <div id="chatMessages" style="background: #f8f9fa; border-radius: 12px; padding: 20px; min-height: 300px; max-height: 500px; overflow-y: auto; margin-bottom: 16px;">
                        <div style="text-align: center; color: #6c757d; padding: 40px 20px;">
                            <div style="font-size: 2.5rem; margin-bottom: 12px;">ü§ñ</div>
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">Your AI Financial Advisor is Ready</div>
                            <div style="font-size: 0.9rem;">Ask me anything about your financial plan!</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="chatInput" placeholder="Ask your question..." 
                            style="flex: 1; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 0.95rem;"
                            onkeypress="if(event.key === 'Enter') sendChatMessage()">
                        <button class="upload-btn" onclick="sendChatMessage()" style="padding: 12px 24px;">
                            Send
                        </button>
                    </div>
                    
                    ${!ANTHROPIC_API_KEY ? `
                        <div class="alert alert-warning" style="margin-top: 16px;">
                            <strong>‚ö†Ô∏è API Key Required</strong>
                            <p>Please enter your Claude API key in the upload section above to use the AI Advisor.</p>
                        </div>
                    ` : ''}
                `;
            }
        }
        
        let chatHistory = [];
        
        async function sendChatMessage() {
            const apiKey = ANTHROPIC_API_KEY;
            if (!apiKey) {
                alert('‚ö†Ô∏è Please enter your Claude API key in the upload section first!\n\nGet it from: console.anthropic.com');
                return;
            }
            
            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            if (!question) return;
            
            const messagesDiv = document.getElementById('chatMessages');
            
            // Add user message
            messagesDiv.innerHTML += `
                <div style="background: white; padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #667eea;">
                    <div style="font-weight: 600; color: #667eea; margin-bottom: 4px;">You:</div>
                    <div style="color: #495057;">${question}</div>
                </div>
            `;
            
            // Show typing indicator
            messagesDiv.innerHTML += `
                <div id="typing" style="background: #e9ecef; padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #28a745;">
                    <div style="font-weight: 600; color: #28a745; margin-bottom: 4px;">AI Advisor:</div>
                    <div style="color: #6c757d;">Thinking...</div>
                </div>
            `;
            
            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Prepare context
            const context = currentResults ? `
Current Financial Profile:
- Age: ${currentResults.inputs.age}, Retirement: ${currentResults.inputs.retirementAge}
- Health Score: ${currentResults.healthScore}/100
- Annual Income: ‚Çπ${currentResults.inputs.annualSalary}
- Monthly Expenses: ‚Çπ${currentResults.inputs.monthlyExpenses}
- Current Portfolio: ‚Çπ${currentResults.finalPortfolio}
- Retirement Need: ‚Çπ${currentResults.corpusNeeded}
- Gap/Surplus: ‚Çπ${currentResults.gap} (${currentResults.gap >= 0 ? 'surplus' : 'shortfall'})
- Emergency Fund: ‚Çπ${currentResults.inputs.bankBalance} / ‚Çπ${currentResults.inputs.emergencyTarget}
- Life Insurance: ‚Çπ${currentResults.inputs.lifeInsurance} / ‚Çπ${currentResults.inputs.insuranceNeeded}
- Loans: ‚Çπ${currentResults.inputs.homeLoan}
` : 'No financial plan generated yet. Please fill the form and generate a plan first.';
            
            const systemPrompt = `You are a certified financial planner helping a client. ${context}

Answer their question with:
1. Direct, actionable advice
2. Specific numbers when relevant
3. Trade-offs to consider
4. One concrete next step

Keep responses under 200 words, friendly and practical.`;
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 800,
                        system: systemPrompt,
                        messages: [
                            ...chatHistory,
                            { role: 'user', content: question }
                        ]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                const answer = data.content.find(c => c.type === 'text')?.text || '';
                
                // Update chat history
                chatHistory.push(
                    { role: 'user', content: question },
                    { role: 'assistant', content: answer }
                );
                
                // Remove typing indicator and add response
                document.getElementById('typing').remove();
                messagesDiv.innerHTML += `
                    <div style="background: #e9ecef; padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #28a745;">
                        <div style="font-weight: 600; color: #28a745; margin-bottom: 4px;">AI Advisor:</div>
                        <div style="color: #495057; white-space: pre-line; line-height: 1.6;">${answer}</div>
                    </div>
                `;
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('typing').remove();
                messagesDiv.innerHTML += `
                    <div style="background: #f8d7da; padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #dc3545;">
                        <div style="font-weight: 600; color: #dc3545; margin-bottom: 4px;">Error:</div>
                        <div style="color: #721c24;">Failed to get response. Please check your API key.</div>
                    </div>
                `;
            }
        }
        
        function recalculateScenario() {
            // Get scenario inputs
            const equityReturn = parseFloat(document.getElementById('scenario_equity_return')?.value || 12) / 100;
            const reReturn = parseFloat(document.getElementById('scenario_re_return')?.value || 6) / 100;
            const debtReturn = parseFloat(document.getElementById('scenario_debt_return')?.value || 6) / 100;
            const salaryGrowth = parseFloat(document.getElementById('scenario_salary_growth')?.value || 5) / 100;

            // Show what the new assumptions would be
            const scenarioResults = document.getElementById('scenarioResults');
            if (currentResults) {
                // Simple projection with new rates
                const yearsToRet = currentResults.inputs.retirementAge - currentResults.inputs.age;
                let projectedPortfolio = currentResults.inputs.sipPortfolio + currentResults.inputs.directEquity +
                                         currentResults.inputs.realEstate + currentResults.inputs.bankBalance;

                // Rough projection with new returns
                for (let y = 0; y < yearsToRet; y++) {
                    const sipContrib = currentResults.inputs.monthlySIP * 12 * Math.pow(1 + currentResults.inputs.sipStepup, y);
                    projectedPortfolio = projectedPortfolio * (1 + equityReturn * 0.6 + reReturn * 0.25 + debtReturn * 0.15) + sipContrib;
                }

                const gap = projectedPortfolio - currentResults.corpusNeeded;
                const gapPercent = (gap / currentResults.corpusNeeded) * 100;

                scenarioResults.innerHTML = `
                    <div class="alert ${gap >= 0 ? 'alert-success' : 'alert-warning'}">
                        <strong>${gap >= 0 ? '‚úÖ With New Assumptions: ON TRACK' : '‚ö†Ô∏è With New Assumptions: NEEDS ATTENTION'}</strong>
                        <p style="margin-top: 8px;">Assumptions: Equity ${(equityReturn * 100).toFixed(0)}%, RE ${(reReturn * 100).toFixed(0)}%, Debt ${(debtReturn * 100).toFixed(0)}%, Salary Growth ${(salaryGrowth * 100).toFixed(0)}%</p>
                        <p>Projected Portfolio at ${currentResults.inputs.retirementAge}: <strong>${formatCurrency(projectedPortfolio)}</strong></p>
                        <p>Corpus Needed: <strong>${formatCurrency(currentResults.corpusNeeded)}</strong></p>
                        <p style="font-weight: 700; color: ${gap >= 0 ? '#28a745' : '#dc3545'};">
                            ${gap >= 0 ? 'Surplus' : 'Shortfall'}: ${formatCurrency(Math.abs(gap))} (${Math.abs(gapPercent).toFixed(1)}%)
                        </p>
                    </div>
                `;
            }
        }
        
        async function getAIHealthInsights() {
            const apiKey = ANTHROPIC_API_KEY;
            if (!apiKey) {
                alert('‚ö†Ô∏è Please enter your Claude API key in the upload section first!\n\nGet it from: console.anthropic.com');
                return;
            }
            
            if (!currentResults) {
                alert('Please generate your financial plan first!');
                return;
            }
            
            const insightsDiv = document.getElementById('aiHealthInsights');
            insightsDiv.innerHTML = '<div style="color: #667eea; font-weight: 600; text-align: center;">‚è≥ AI is analyzing your financial health in detail...</div>';
            
            const inputs = currentResults.inputs;
            const results = currentResults;
            
            const prompt = `You are a certified financial planner. Analyze this financial profile and provide detailed insights:

Financial Health Score: ${results.healthScore}/100

Profile:
- Age: ${inputs.age}, Retirement Target: ${inputs.retirementAge}
- Income: ‚Çπ${inputs.annualSalary}/year, Expenses: ‚Çπ${inputs.monthlyExpenses}/month
- Investments: SIP ‚Çπ${inputs.sipPortfolio}, Equity ‚Çπ${inputs.directEquity}, RE ‚Çπ${inputs.realEstate}
- Liabilities: Home Loan ‚Çπ${inputs.homeLoan} at ${(inputs.loanRate * 100).toFixed(1)}%
- Protection: Life Insurance ‚Çπ${inputs.lifeInsurance} (needs ‚Çπ${inputs.insuranceNeeded})
- Emergency Fund: ‚Çπ${inputs.bankBalance} (target ‚Çπ${inputs.emergencyTarget})
- Retirement: Portfolio ‚Çπ${results.finalPortfolio} vs Need ‚Çπ${results.corpusNeeded} (${results.gap >= 0 ? 'surplus' : 'gap'} ‚Çπ${Math.abs(results.gap)})

Provide:
1. Top 3 strengths in their financial profile
2. Top 3 areas of concern with specific impact
3. Most critical action to take in next 30 days
4. One contrarian/non-obvious insight based on their data

Keep under 400 words. Be specific, actionable, and empathetic.`;
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1500,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                const insights = data.content.find(c => c.type === 'text')?.text || '';
                
                insightsDiv.innerHTML = `
                    <div class="score-item" style="background: #f0f4ff; border-color: #667eea; text-align: left;">
                        <h4 style="color: #667eea; margin-bottom: 12px;">ü§ñ AI Detailed Analysis</h4>
                        <div style="white-space: pre-line; line-height: 1.7; font-size: 0.9rem;">${insights}</div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error getting AI insights:', error);
                insightsDiv.innerHTML = '<div style="color: #dc3545; text-align: center;">‚ùå Failed to get AI insights. Please check your API key and try again.</div>';
            }
        }
        
        async function getAIAllocationAdvice() {
            const apiKey = ANTHROPIC_API_KEY;
            if (!apiKey) {
                alert('‚ö†Ô∏è Please enter your Claude API key in the upload section first!\n\nGet it from: console.anthropic.com');
                return;
            }
            
            const adviceDiv = document.getElementById('aiAdvice');
            adviceDiv.innerHTML = '<div style="color: #667eea; font-weight: 600;">‚è≥ AI is analyzing your profile and generating personalized advice...</div>';
            
            const recommendation = await askAIForRecommendations();
            
            if (recommendation) {
                adviceDiv.innerHTML = `
                    <div class="alert alert-success" style="margin-top: 0; background: #f0f4ff; border-color: #667eea;">
                        <strong>ü§ñ AI Personalized Advice:</strong>
                        <div style="margin-top: 10px; white-space: pre-line; line-height: 1.6; font-size: 0.9rem;">${recommendation}</div>
                    </div>
                `;
            } else {
                adviceDiv.innerHTML = '<div style="color: #dc3545;">‚ùå Failed to get AI recommendations. Please check your API key and try again.</div>';
            }
        }
        
        function updateAllocationTotal() {
            const equity = parseFloat(document.getElementById('alloc_equity').value) || 0;
            const realEstate = parseFloat(document.getElementById('alloc_realestate').value) || 0;
            const debt = parseFloat(document.getElementById('alloc_debt').value) || 0;
            const total = equity + realEstate + debt;
            
            document.getElementById('alloc_total').value = total;
            document.getElementById('currentTotal').textContent = total;
            
            const warning = document.getElementById('allocationWarning');
            if (total !== 100) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
            
            // Update preview amounts
            if (currentResults) {
                const annualSalary = currentResults.inputs.annualSalary;
                const annualExpenses = currentResults.inputs.monthlyExpenses * 12;
                const annualSIP = currentResults.inputs.monthlySIP * 12;
                // Proper EMI calculation
                const loanRateDecimal3 = currentResults.inputs.loanRate / 100;
                const monthlyRate3 = loanRateDecimal3 / 12;
                const loanTenureMonths3 = 240;
                let estimatedEMI = 0;
                if (currentResults.inputs.homeLoan > 0 && monthlyRate3 > 0) {
                    const cf3 = Math.pow(1 + monthlyRate3, loanTenureMonths3);
                    estimatedEMI = currentResults.inputs.homeLoan * monthlyRate3 * cf3 / (cf3 - 1);
                }
                const annualEMI = estimatedEMI * 12;
                
                // Calculate current annual education from children data
                let annualEducation = 0;
                if (currentResults.inputs.educationCosts && currentResults.inputs.educationCosts.length > 0) {
                    annualEducation = currentResults.inputs.educationCosts.reduce((sum, cost) => sum + (cost || 0), 0);
                }
                
                const totalFixedCommitments = annualExpenses + annualSIP + currentResults.inputs.insurancePremium + 
                                            annualEducation + currentResults.inputs.holidayBudget + 
                                            currentResults.inputs.homeLoanPrepay + annualEMI;
                const netSavingsAvailable = annualSalary - totalFixedCommitments;
                
                updateAllocationPreview(netSavingsAvailable);
            }
        }
        
        function updateAllocationPreview(netSavingsAvailable) {
            const equity = parseFloat(document.getElementById('alloc_equity')?.value || 50) / 100;
            const realEstate = parseFloat(document.getElementById('alloc_realestate')?.value || 30) / 100;
            const debt = parseFloat(document.getElementById('alloc_debt')?.value || 20) / 100;
            
            const equityAmount = netSavingsAvailable * equity;
            const realEstateAmount = netSavingsAvailable * realEstate;
            const debtAmount = netSavingsAvailable * debt;
            
            const previewEquity = document.getElementById('preview_equity');
            const previewRE = document.getElementById('preview_realestate');
            const previewDebt = document.getElementById('preview_debt');
            
            if (previewEquity) previewEquity.textContent = formatCurrency(equityAmount);
            if (previewRE) previewRE.textContent = formatCurrency(realEstateAmount);
            if (previewDebt) previewDebt.textContent = formatCurrency(debtAmount);
        }
    </script>
</body>
</html>
